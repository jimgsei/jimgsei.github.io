<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajedrez</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&display=swap');
        
        :root {
            --board-size: min(85vw, 85vh);
            --max-board-size: 750px;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            color: var(--text-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.4s ease;
        }
        
        body[data-board-theme="marble"] {
            --board-light: #EAEAEA; --board-dark: #6E7B8B;
            --background-color: #1F232A; --text-color: #F0F0F0;
            --highlight-selected: rgba(255, 215, 0, 0.5); --highlight-valid: rgba(0, 191, 255, 0.4);
            --highlight-last-move: rgba(200, 200, 200, 0.25); --captured-bg: rgba(0, 0, 0, 0.2);
            --check-color: rgba(255, 0, 0, 0.5);
        }
        body[data-board-theme="wood"] {
            --board-light: #F0D9B5; --board-dark: #B58863;
            --background-color: #3A3A3A; --text-color: #F5F5F5;
            --highlight-selected: rgba(0, 128, 0, 0.4); --highlight-valid: rgba(20, 80, 20, 0.5);
            --highlight-last-move: rgba(255, 255, 0, 0.2); --captured-bg: rgba(0, 0, 0, 0.15);
            --check-color: rgba(200, 0, 0, 0.6);
        }
        body[data-board-theme="emerald"] {
            --board-light: #A9D1B7; --board-dark: #5F8575;
            --background-color: #2E2E2E; --text-color: #E0E0E0;
            --highlight-selected: rgba(212, 175, 55, 0.5); --highlight-valid: rgba(140, 198, 63, 0.5);
            --highlight-last-move: rgba(255, 255, 255, 0.15); --captured-bg: rgba(255, 255, 255, 0.05);
            --check-color: rgba(255, 20, 20, 0.5);
        }
        body[data-board-theme="oceanic"] {
            --board-light: #D1E0E0; --board-dark: #6A869F;
            --background-color: #2C3E50; --text-color: #ECF0F1;
            --highlight-selected: rgba(241, 196, 15, 0.5); --highlight-valid: rgba(26, 188, 156, 0.5);
            --highlight-last-move: rgba(52, 152, 219, 0.2); --captured-bg: rgba(0, 0, 0, 0.2);
            --check-color: rgba(192, 57, 43, 0.6);
        }

        #game-wrapper {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; gap: 15px;
        }
        #game-header {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; max-width: var(--max-board-size);
            flex-wrap: wrap; gap: 10px;
        }
        #status-message { font-size: 1.8rem; font-weight: 700; letter-spacing: 1px; flex-grow: 1; }
        .theme-controls { display: flex; flex-wrap: wrap; gap: 10px; }
        .theme-button {
            font-family: 'Cormorant Garamond', serif; font-size: 1rem; padding: 8px 15px;
            background-color: var(--board-dark); color: var(--board-light);
            border: 1px solid var(--board-light); border-radius: 5px;
            cursor: pointer; transition: background-color 0.3s, color 0.3s;
        }
        .theme-button:disabled { cursor: not-allowed; opacity: 0.5; }
        .theme-button:hover:not(:disabled) { background-color: var(--board-light); color: var(--board-dark); }

        #main-content { display: flex; flex-direction: row; align-items: center; gap: 20px; }
        
        #chessboard {
            width: var(--board-size); height: var(--board-size);
            max-width: var(--max-board-size); max-height: var(--max-board-size);
            display: grid; grid-template-columns: repeat(8, 1fr);
            border: 2px solid #000; box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
        }
        #chessboard.game-over { pointer-events: none; opacity: 0.8; }
        .square {
            aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center;
            position: relative; transition: background-color 0.4s ease;
        }
        .square.in-check { background-color: var(--check-color) !important; }
        .square.light { background-color: var(--board-light); }
        .square.dark { background-color: var(--board-dark); }
        .piece {
            width: 88%; height: 88%; cursor: grab;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.4));
            transition: transform 0.1s ease-in-out;
        }
        .piece:active { cursor: grabbing; transform: scale(1.1); }
        .selected { background-color: var(--highlight-selected) !important; }
        .valid-move-dot {
            width: 35%; height: 35%; background-color: var(--highlight-valid);
            border-radius: 50%; position: absolute; pointer-events: none;
        }
        .last-move { background-color: var(--highlight-last-move) !important; }
        .captured-pieces-area {
            width: 80px; height: var(--board-size); max-height: var(--max-board-size);
            background-color: var(--captured-bg); border-radius: 10px;
            padding: 10px; box-sizing: border-box;
            display: flex; flex-direction: column; flex-wrap: wrap; gap: 5px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5); transition: background-color 0.4s ease;
        }
        .captured-pieces-area .piece { width: 30px; height: 30px; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.5)); }
        
        #promotion-modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px); justify-content: center; align-items: center;
        }
        #promotion-choices {
            background-color: var(--background-color); padding: 25px;
            border: 1px solid var(--board-light); border-radius: 10px;
            display: flex; gap: 20px;
        }
        #promotion-choices .piece { width: 70px; height: 70px; cursor: pointer; transition: transform 0.2s; }
        #promotion-choices .piece:hover { transform: scale(1.15); }
        
        @media (max-width: 900px) {
            #main-content { flex-direction: column; width: 100%; align-items: center; gap: 15px; }
            #game-header { justify-content: center; }
            #status-message { font-size: 1.2rem; text-align: center; width: 100%; order: -1; }
            .captured-pieces-area {
                flex-direction: row; width: var(--board-size);
                height: 50px; max-width: var(--max-board-size); align-items: center;
            }
            .captured-pieces-area .piece { width: 25px; height: 25px; }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-header">
            <div id="status-message"></div>
            <div class="theme-controls">
                <button id="undo-button" class="theme-button">Deshacer</button>
                <button id="board-theme-switcher" class="theme-button">Estilo Tablero</button>
                <button id="piece-theme-switcher" class="theme-button">Estilo Figuras</button>
            </div>
        </div>
        <div id="main-content">
            <div class="captured-pieces-area" id="captured-black"></div>
            <div id="chessboard"></div>
            <div class="captured-pieces-area" id="captured-white"></div>
        </div>
    </div>
    <div id="promotion-modal"><div id="promotion-choices"></div></div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const boardElement = document.getElementById('chessboard');
        const statusElement = document.getElementById('status-message');
        const promotionModal = document.getElementById('promotion-modal');
        const promotionChoices = document.getElementById('promotion-choices');
        const capturedWhiteContainer = document.getElementById('captured-white');
        const capturedBlackContainer = document.getElementById('captured-black');
        const boardThemeSwitcher = document.getElementById('board-theme-switcher');
        const pieceThemeSwitcher = document.getElementById('piece-theme-switcher');
        const undoButton = document.getElementById('undo-button');

        const PIECE_THEMES = {
            maestro: { name: 'Maestro', pieces: {'white_king': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="#FFF" stroke="#000" stroke-width="1.2" stroke-linejoin="round"><path d="M22.5 7.5L22.5 11.5M20.5 9.5L24.5 9.5" fill="none" stroke-linecap="round"/><path d="M22.5 11.5C25.5 14.5 25.5 18 22.5 20C19.5 18 19.5 14.5 22.5 11.5L22.5 11.5z" stroke-linecap="round"/><path d="M22.5 20L22.5 22.5" fill="none" stroke-linecap="round"/><path d="M12.5 39.5L32.5 39.5L32.5 36.5L12.5 36.5L12.5 39.5z" stroke-linecap="round"/><path d="M14.5 36.5L14.5 31.5L30.5 31.5L30.5 36.5z" stroke-linecap="round"/><path d="M14.5 31.5C14.5 24.5 22.5 22.5 22.5 22.5C22.5 22.5 30.5 24.5 30.5 31.5L14.5 31.5z" stroke-linecap="round"/></g></svg>`, 'white_queen': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="#FFF" stroke="#000" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.5 12.5L33.5 12.5L30.5 18.5L14.5 18.5L11.5 12.5z" /><path d="M12.5 39.5L32.5 39.5L32.5 36.5L12.5 36.5L12.5 39.5z" /><path d="M14.5 36.5L14.5 31.5L30.5 31.5L30.5 36.5z" /><path d="M14.5 31.5C14.5 24.5 22.5 22.5 22.5 22.5C22.5 22.5 30.5 24.5 30.5 31.5z" /><path d="M14.5 18.5L22.5 22.5L30.5 18.5" fill="none" /><path d="M11.5 12.5L22.5 22.5L33.5 12.5" fill="none" /><circle cx="6.5" cy="11.5" r="2.5"/><circle cx="14.5" cy="9.5" r="2.5"/><circle cx="22.5" cy="8.5" r="2.5"/><circle cx="30.5" cy="9.5" r="2.5"/><circle cx="38.5" cy="11.5" r="2.5"/></g></svg>`, 'white_rook': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="#FFF" stroke="#000" stroke-width="1.2" stroke-linejoin="round"><path d="M12.5 39.5L32.5 39.5L32.5 36.5L12.5 36.5z" stroke-linecap="round"/><path d="M14.5 36.5L14.5 31.5L30.5 31.5L30.5 36.5z" stroke-linecap="round"/><path d="M14.5 31.5C14.5 24.5 22.5 22.5 22.5 22.5C22.5 22.5 30.5 24.5 30.5 31.5z" stroke-linecap="round"/><path d="M12.5 9.5L15.5 9.5L15.5 12.5L19.5 12.5L19.5 9.5L25.5 9.5L25.5 12.5L29.5 12.5L29.5 9.5L32.5 9.5L32.5 18.5L12.5 18.5z" /><path d="M12.5 18.5L22.5 22.5L32.5 18.5" fill="none" /></g></svg>`, 'white_bishop': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="#FFF" stroke="#000" stroke-width="1.2" stroke-linejoin="round"><path d="M12.5 39.5L32.5 39.5L32.5 36.5L12.5 36.5z" stroke-linecap="round"/><path d="M14.5 36.5L14.5 31.5L30.5 31.5L30.5 36.5z" stroke-linecap="round"/><path d="M14.5 31.5C14.5 24.5 22.5 22.5 22.5 22.5C22.5 22.5 30.5 24.5 30.5 31.5z" stroke-linecap="round"/><path d="M22.5,10.5 L22.5,10.5 C24.5,12.5 24.5,15.5 22.5,17.5 C20.5,15.5 20.5,12.5 22.5,10.5" /><path d="M18.5 16.5L26.5 16.5" fill="none" stroke-linecap="round" stroke-width="0.8" /><path d="M22.5 17.5L22.5 22.5" fill="none" stroke-linecap="round"/><path d="M15.5,29.5 C15.5,29.5 18.5,25.5 22.5,22.5 C26.5,25.5 29.5,29.5 29.5,29.5" fill="none" stroke-linecap="round"/></g></svg>`, 'white_knight': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="#FFF" stroke="#000" stroke-width="1.2" stroke-linejoin="round"><path d="M 9.5,39.5 L 35.5,39.5 L 35.5,36.5 L 9.5,36.5 L 9.5,39.5 z" stroke-linecap="round"/><path d="M 11.5,36.5 L 11.5,31.5 L 33.5,31.5 L 33.5,36.5 z" stroke-linecap="round"/><path d="M 11.5,31.5 C 11.5,24.5 19.5,22.5 19.5,22.5 C 19.5,22.5 27.5,24.5 27.5,31.5 L 11.5,31.5 z" stroke-linecap="round"/><path d="M 14,26 C 14.2,22.3 16,16.5 23.5,12.5 C 25.9,13.2 27.5,18.5 27,20 C 25,23.5 21,24.5 19.5,22.5" stroke-linecap="round" fill="none"/><path d="M 19.5 12.5L21.5 10.5L23.5 12.5" stroke-linecap="round"/></g></svg>`, 'white_pawn': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="#FFF" stroke="#000" stroke-width="1.2" stroke-linejoin="round"><path d="M22.5 14.5 A 5 5 0 1 1 22.5 24.5 A 5 5 0 1 1 22.5 14.5 z" /><path d="M12.5 39.5L32.5 39.5L32.5 36.5L12.5 36.5z" stroke-linecap="round"/><path d="M14.5 36.5L14.5 31.5L30.5 31.5L30.5 36.5z" stroke-linecap="round"/><path d="M17.5 31.5L27.5 31.5L22.5 24.5z" stroke-linecap="round"/></g></svg>`, 'black_king': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="#2A2A2A" stroke="#FFF" stroke-width="1.2" stroke-linejoin="round"><path d="M22.5 7.5L22.5 11.5M20.5 9.5L24.5 9.5" fill="none" stroke-linecap="round"/><path d="M22.5 11.5C25.5 14.5 25.5 18 22.5 20C19.5 18 19.5 14.5 22.5 11.5L22.5 11.5z" stroke-linecap="round"/><path d="M22.5 20L22.5 22.5" fill="none" stroke-linecap="round"/><path d="M12.5 39.5L32.5 39.5L32.5 36.5L12.5 36.5L12.5 39.5z" stroke-linecap="round"/><path d="M14.5 36.5L14.5 31.5L30.5 31.5L30.5 36.5z" stroke-linecap="round"/><path d="M14.5 31.5C14.5 24.5 22.5 22.5 22.5 22.5C22.5 22.5 30.5 24.5 30.5 31.5L14.5 31.5z" stroke-linecap="round"/></g></svg>`, 'black_queen': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="#2A2A2A" stroke="#FFF" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.5 12.5L33.5 12.5L30.5 18.5L14.5 18.5L11.5 12.5z" /><path d="M12.5 39.5L32.5 39.5L32.5 36.5L12.5 36.5L12.5 39.5z" /><path d="M14.5 36.5L14.5 31.5L30.5 31.5L30.5 36.5z" /><path d="M14.5 31.5C14.5 24.5 22.5 22.5 22.5 22.5C22.5 22.5 30.5 24.5 30.5 31.5z" /><path d="M14.5 18.5L22.5 22.5L30.5 18.5" fill="none" /><path d="M11.5 12.5L22.5 22.5L33.5 12.5" fill="none" /><circle cx="6.5" cy="11.5" r="2.5"/><circle cx="14.5" cy="9.5" r="2.5"/><circle cx="22.5" cy="8.5" r="2.5"/><circle cx="30.5" cy="9.5" r="2.5"/><circle cx="38.5" cy="11.5" r="2.5"/></g></svg>`, 'black_rook': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="#2A2A2A" stroke="#FFF" stroke-width="1.2" stroke-linejoin="round"><path d="M12.5 39.5L32.5 39.5L32.5 36.5L12.5 36.5z" stroke-linecap="round"/><path d="M14.5 36.5L14.5 31.5L30.5 31.5L30.5 36.5z" stroke-linecap="round"/><path d="M14.5 31.5C14.5 24.5 22.5 22.5 22.5 22.5C22.s5 22.5 30.5 24.5 30.5 31.5z" stroke-linecap="round"/><path d="M12.5 9.5L15.5 9.5L15.5 12.5L19.5 12.5L19.5 9.5L25.5 9.5L25.5 12.5L29.5 12.5L29.5 9.5L32.5 9.5L32.5 18.5L12.5 18.5z" /><path d="M12.5 18.5L22.5 22.5L32.5 18.5" fill="none" /></g></svg>`, 'black_bishop': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="#2A2A2A" stroke="#FFF" stroke-width="1.2" stroke-linejoin="round"><path d="M12.5 39.5L32.5 39.5L32.5 36.5L12.5 36.5z" stroke-linecap="round"/><path d="M14.5 36.5L14.5 31.5L30.5 31.5L30.5 36.5z" stroke-linecap="round"/><path d="M14.5 31.5C14.5 24.5 22.5 22.5 22.5 22.5C22.5 22.5 30.5 24.5 30.5 31.5z" stroke-linecap="round"/><path d="M22.5,10.5 L22.5,10.5 C24.5,12.5 24.5,15.5 22.5,17.5 C20.5,15.5 20.5,12.5 22.5,10.5" /><path d="M18.5 16.5L26.5 16.5" fill="none" stroke-linecap="round" stroke-width="0.8" /><path d="M22.5 17.5L22.5 22.5" fill="none" stroke-linecap="round"/><path d="M15.5,29.5 C15.5,29.5 18.5,25.5 22.5,22.5 C26.5,25.5 29.5,29.5 29.5,29.5" fill="none" stroke-linecap="round"/></g></svg>`, 'black_knight': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="#2A2A2A" stroke="#FFF" stroke-width="1.2" stroke-linejoin="round"><path d="M 9.5,39.5 L 35.5,39.5 L 35.5,36.5 L 9.5,36.5 L 9.5,39.5 z" stroke-linecap="round"/><path d="M 11.5,36.5 L 11.5,31.5 L 33.5,31.5 L 33.5,36.5 z" stroke-linecap="round"/><path d="M 11.5,31.5 C 11.5,24.5 19.5,22.5 19.5,22.5 C 19.5,22.5 27.5,24.5 27.5,31.5 L 11.5,31.5 z" stroke-linecap="round"/><path d="M 14,26 C 14.2,22.3 16,16.5 23.5,12.5 C 25.9,13.2 27.5,18.5 27,20 C 25,23.5 21,24.5 19.5,22.5" stroke-linecap="round" fill="none"/><path d="M 19.5 12.5L21.5 10.5L23.5 12.5" stroke-linecap="round"/></g></svg>`, 'black_pawn': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="#2A2A2A" stroke="#FFF" stroke-width="1.2" stroke-linejoin="round"><path d="M22.5 14.5 A 5 5 0 1 1 22.5 24.5 A 5 5 0 1 1 22.5 14.5 z" /><path d="M12.5 39.5L32.5 39.5L32.5 36.5L12.5 36.5z" stroke-linecap="round"/><path d="M14.5 36.5L14.5 31.5L30.5 31.5L30.5 36.5z" stroke-linecap="round"/><path d="M17.5 31.5L27.5 31.5L22.5 24.5z" stroke-linecap="round"/></g></svg>`} },
            classic: { name: 'Clásico', pieces: {'white_king': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece white"><g fill="#fff" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22.5 11.63V6M20 8h5" stroke-linejoin="miter"/><path d="M22.5 25s4.5-7.5 3-10.5c0 0-1.5-3-3-3s-3 3-3 3c-1.5 3 3 10.5 3 10.5" fill="#fff" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M11.5 37c5.5 3.5 15.5 3.5 21 0v-7s9-4.5 6-10.5c-4-6.5-13.5-3.5-16 4V27v-3.5c-2.5-7.5-12-10.5-16-4-3 6 6 10.5 6 10.5v7" fill="#fff"/><path d="M11.5 30c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0" fill="none"/></g></svg>`, 'white_queen': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece white"><g fill="#fff" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM24.5 7.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM41 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM16 8.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM33 9a2 2 0 1 1-4 0 2 2 0 1 1 4 0z"/><path d="M9 26c8.5-1.5 21-1.5 27 0l2-12-7 11V11l-5.5 13.5-3-15-3 15L15 11v14L8 14l1 12z" stroke-linecap="butt"/><path d="M9 26c0 2 1.5 2 2.5 4 1 1.5 1 3.5 0 4.5-1 1-.5 3.5 1 4.5 1.5 1 2.5 2.5 2.5 4.5s-1.5 4-2.5 4-2.5-2-2.5-4" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M36 26c0 2-1.5 2-2.5 4-1 1.5-1 3.5 0 4.5 1 1 .5 3.5-1 4.5-1.5 1-2.5 2.5-2.5 4.5s1.5 4 2.5 4 2.5-2 2.s5-4" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M9 39h27" fill="none" stroke-linejoin="miter"/></g></svg>`, 'white_rook': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece white"><g fill="#fff" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 39h27v-3H9v3zM12 36v-4h21v4H12zM11 14V9h4v2h5V9h5v2h5V9h4v5" stroke-linecap="butt"/><path d="M34 14l-3 3H14l-3-3"/><path d="M31 17v12.5H14V17" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M31 29.5l1.5 2.5h-20l1.5-2.5"/><path d="M14 17h17" fill="none"/></g></svg>`, 'white_bishop': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece white"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><g fill="#fff" stroke-linecap="butt"><path d="M9 36c3.39-.97 10.11.43 13.5-2 3.39 2.43 10.11 1.03 13.5 2 0 0 1.65.54 3 2-.68.97-1.65.99-3 .5-3.39-.97-10.11.43-13.5-2-3.39 2.43-10.11 1.03-13.5 2 0 0-1.65.54-3 2-.68.97-1.65.99-3-.5z"/><path d="M15 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11-4-11 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2zM25 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z"/></g><path d="M17.5 26h10M15 32h15m-7.5-14.5v5" stroke-linejoin="miter"/></g></svg>`, 'white_knight': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece white"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10c10.5 1 16.5 8 16 29H15c-4.5-8.5-4-17-4-20 0-7 4-12 11-14" fill="#fff"/><path d="M24 18c.38 2.91-5.55 7.37-8 9-3 2-2.82 4.34-5 4-1.042-.94 1.41-3.04 0-3-1 0 .19 1.23-1 2-1 0-4.003-1.49-4-4 .003-2.51 4-3 4-4s-1.87-4.205-2-5c-.24-1.56 2.5-3 2-3s1 2 2 2 2-3 2-3" fill="#fff"/><path d="M9.5 25.5a.5.5 0 1 1-1 0 .5.5 0 1 1 1 0z" fill="#000"/><path d="M15 15.5c-1.5 1.5-2.5 4-2.5 6" stroke-linecap="butt"/></g></svg>`, 'white_pawn': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece white"><path d="M22.5 9c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.38C17.33 16.5 16 18.59 16 21c0 2.03.94 3.84 2.41 5.03-3 1-5.06 2.02-6.41 3.47-1.35 1.45-2.22 3.44-2.22 5.5h25.44c0-2.06-.87-4.05-2.22-5.5-1.35-1.45-3.41-2.47-6.41-3.47C28.06 24.84 29 23.03 29 21c0-2.41-1.33-4.5-3.28-5.62.49-.67.78-1.49.78-2.38 0-2.21-1.79-4-4-4z" fill="#fff" stroke="#000" stroke-width="1.5" stroke-linecap="round"/></svg>`, 'black_king': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece black"><g fill="#000" fill-rule="evenodd" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22.5 11.63V6M20 8h5" stroke-linejoin="miter"/><path d="M22.5 25s4.5-7.5 3-10.5c0 0-1.5-3-3-3s-3 3-3 3c-1.5 3 3 10.5 3 10.5" fill="#000" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M11.5 37c5.5 3.5 15.5 3.5 21 0v-7s9-4.5 6-10.5c-4-6.5-13.5-3.5-16 4V27v-3.5c-2.5-7.5-12-10.5-16-4-3 6 6 10.5 6 10.5v7" fill="#000"/><path d="M11.5 30c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0" fill="none"/></g></svg>`, 'black_queen': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece black"><g fill="#000" fill-rule="evenodd" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM24.5 7.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM41 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM16 8.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM33 9a2 2 0 1 1-4 0 2 2 0 1 1 4 0z"/><path d="M9 26c8.5-1.5 21-1.5 27 0l2-12-7 11V11l-5.5 13.5-3-15-3 15L15 11v14L8 14l1 12z" stroke-linecap="butt"/><path d="M9 26c0 2 1.5 2 2.5 4 1 1.5 1 3.5 0 4.5-1 1-.5 3.5 1 4.5 1.5 1 2.5 2.5 2.5 4.5s-1.5 4-2.5 4-2.5-2-2.5-4" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M36 26c0 2-1.5 2-2.5 4-1 1.5-1 3.5 0 4.5 1 1 .5 3.5-1 4.5-1.5 1-2.5 2.5-2.5 4.5s1.5 4 2.5 4 2.5-2 2.5-4" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M9 39h27" fill="none" stroke-linejoin="miter"/></g></svg>`, 'black_rook': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece black"><g fill="#000" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 39h27v-3H9v3zM12 36v-4h21v4H12zM11 14V9h4v2h5V9h5v2h5V9h4v5" stroke-linecap="butt"/><path d="M34 14l-3 3H14l-3-3"/><path d="M31 17v12.5H14V17" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M31 29.5l1.5 2.5h-20l1.5-2.5"/><path d="M14 17h17" fill="none"/></g></svg>`, 'black_bishop': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece black"><g fill="none" fill-rule="evenodd" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><g fill="#000" stroke-linecap="butt"><path d="M9 36c3.39-.97 10.11.43 13.5-2 3.39 2.43 10.11 1.03 13.5 2 0 0 1.65.54 3 2-.68.97-1.65.99-3 .5-3.39-.97-10.11.43-13.5-2-3.39 2.43-10.11 1.03-13.5 2 0 0-1.65.54-3 2-.68.97-1.65.99-3-.5z"/><path d="M15 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11-4-11 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2zM25 8a2.5 2.s5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z"/></g><path d="M17.5 26h10M15 32h15m-7.5-14.5v5" stroke-linejoin="miter"/></g></svg>`, 'black_knight': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece black"><g fill="none" fill-rule="evenodd" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10c10.5 1 16.5 8 16 29H15c-4.5-8.5-4-17-4-20 0-7 4-12 11-14" fill="#000"/><path d="M24 18c.38 2.91-5.55 7.37-8 9-3 2-2.82 4.34-5 4-1.042-.94 1.41-3.04 0-3-1 0 .19 1.23-1 2-1 0-4.003-1.49-4-4 .003-2.51 4-3 4-4s-1.87-4.205-2-5c-.24-1.56 2.5-3 2-3s1 2 2 2 2-3 2-3" fill="#000"/><path d="M9.5 25.5a.5.5 0 1 1-1 0 .5.5 0 1 1 1 0z" fill="#fff"/><path d="M15 15.5c-1.5 1.5-2.5 4-2.5 6" stroke-linecap="butt"/></g></svg>`, 'black_pawn': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45" class="piece black"><path d="M22.5 9c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.38C17.33 16.5 16 18.59 16 21c0 2.03.94 3.84 2.41 5.03-3 1-5.06 2.02-6.41 3.47-1.35 1.45-2.22 3.44-2.22 5.5h25.44c0-2.06-.87-4.05-2.22-5.5-1.35-1.45-3.41-2.47-6.41-3.47C28.06 24.84 29 23.03 29 21c0-2.41-1.33-4.5-3.28-5.62.49-.67.78-1.49.78-2.38 0-2.21-1.79-4-4-4z" fill="#000" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/></svg>`} },
            minimalist: { name: 'Minimalista', pieces: {'white_king': `<svg class="piece white" viewBox="0 0 100 100"><rect x="35" y="15" width="30" height="5" fill="currentColor"/><rect x="47" y="20" width="6" height="15" fill="currentColor"/><circle cx="50" cy="50" r="25" fill="none" stroke="currentColor" stroke-width="6"/><rect x="20" y="75" width="60" height="10" fill="currentColor"/></svg>`, 'white_queen': `<svg class="piece white" viewBox="0 0 100 100"><circle cx="50" cy="25" r="10" fill="currentColor"/><circle cx="50" cy="50" r="25" fill="none" stroke="currentColor" stroke-width="6"/><rect x="20" y="75" width="60" height="10" fill="currentColor"/></svg>`, 'white_rook': `<svg class="piece white" viewBox="0 0 100 100"><rect x="25" y="20" width="50" height="55" fill="none" stroke="currentColor" stroke-width="6"/><rect x="20" y="75" width="60" height="10" fill="currentColor"/></svg>`, 'white_bishop': `<svg class="piece white" viewBox="0 0 100 100"><polygon points="50,20 70,75 30,75" fill="none" stroke="currentColor" stroke-width="6"/><rect x="20" y="75" width="60" height="10" fill="currentColor"/></svg>`, 'white_knight': `<svg class="piece white" viewBox="0 0 100 100"><path d="M 30 75 L 30 40 C 30 20, 60 20, 60 40 L 60 50 L 70 40" fill="none" stroke="currentColor" stroke-width="6"/><rect x="20" y="75" width="60" height="10" fill="currentColor"/></svg>`, 'white_pawn': `<svg class="piece white" viewBox="0 0 100 100"><circle cx="50" cy="45" r="15" fill="currentColor"/><rect x="30" y="60" width="40" height="10" fill="currentColor"/></svg>`, 'black_king': `<svg class="piece black" viewBox="0 0 100 100"><rect x="35" y="15" width="30" height="5" fill="currentColor"/><rect x="47" y="20" width="6" height="15" fill="currentColor"/><circle cx="50" cy="50" r="25" fill="currentColor" /><rect x="20" y="75" width="60" height="10" fill="currentColor"/></svg>`, 'black_queen': `<svg class="piece black" viewBox="0 0 100 100"><circle cx="50" cy="25" r="10" fill="currentColor"/><circle cx="50" cy="50" r="25" fill="currentColor" /><rect x="20" y="75" width="60" height="10" fill="currentColor"/></svg>`, 'black_rook': `<svg class="piece black" viewBox="0 0 100 100"><rect x="25" y="20" width="50" height="55" fill="currentColor" /><rect x="20" y="75" width="60" height="10" fill="currentColor"/></svg>`, 'black_bishop': `<svg class="piece black" viewBox="0 0 100 100"><polygon points="50,20 70,75 30,75" fill="currentColor" /><rect x="20" y="75" width="60" height="10" fill="currentColor"/></svg>`, 'black_knight': `<svg class="piece black" viewBox="0 0 100 100"><path d="M 30 75 L 30 40 C 30 20, 60 20, 60 40 L 60 50 L 70 40" fill="currentColor" stroke="currentColor" stroke-width="6"/><rect x="20" y="75" width="60" height="10" fill="currentColor"/></svg>`, 'black_pawn': `<svg class="piece black" viewBox="0 0 100 100"><circle cx="50" cy="45" r="15" fill="currentColor"/><rect x="30" y="60" width="40" height="10" fill="currentColor"/></svg>`} },
            neo: { name: 'Neo', pieces: {'white_king': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22.5 6h-2v3h2m4 0h-2v3h2m-2-3v-3" fill="#fff"/><path d="M22.5 22.5c-3.5-1.5-3.5-6 0-7.5 3.5 1.5 3.5 6 0 7.5zm0 0V39" fill="#fff"/><path d="M12 39h21" stroke-linejoin="miter"/></g></svg>`, 'white_queen': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15l10.5 2.5L33 15l-2 12.5L14 27.5z" fill="#fff"/><path d="M12 15l10.5 12.5L33 15" fill="none"/><path d="M12 27.5l10.5 12.5L33 27.5" fill="none"/><circle cx="6" cy="12" r="2" fill="#fff"/><circle cx="14" cy="9" r="2" fill="#fff"/><circle cx="22.5" cy="8" r="2" fill="#fff"/><circle cx="31" cy="9" r="2" fill="#fff"/><circle cx="39" cy="12" r="2" fill="#fff"/></g></svg>`, 'white_rook': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="#fff" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13 11h19v5h-19zm0 5h19v13h-19zm-3 13h25v5h-25z"/><path d="M15 11V8h15v3"/></g></svg>`, 'white_bishop': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="#fff" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 13.5c4-4 10-4 14 0 4 4 2 10-1.5 16.5-9 2-11-2.5-7-8.5C24.5 18 21 16 16 13.5z"/><path d="M24.5 29.5V39"/><path d="M15 39h15"/><path d="M19 19a3 3 0 100-4 3 3 0 000 4z"/></g></svg>`, 'white_knight': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 25.5c-2.5-3.5-2.5-11.5 3-15.5 5-4 11.5 0 11.5 5.5 0 2.5-1.5 5.5-3.5 7.5-3 3.5-8.5 4.5-8.5 4.5z" fill="#fff"/><path d="M13.5 39.5s-2-20 8.5-24" fill="#fff"/><path d="M13.5 39.5h15" stroke-linejoin="miter"/><path d="M22 39.5v-10.5" fill="#fff"/></g></svg>`, 'white_pawn': `<svg xmlns="http://www.w3.org/2000/svg" class="piece white" viewBox="0 0 45 45"><g fill="#fff" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22.5 39.5v-20m-10-10h20v20h-20z"/></g></svg>`, 'black_king': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22.5 6h-2v3h2m4 0h-2v3h2m-2-3v-3" fill="#000"/><path d="M22.5 22.5c-3.5-1.5-3.5-6 0-7.5 3.5 1.5 3.5 6 0 7.5zm0 0V39" fill="#000"/><path d="M12 39h21" stroke-linejoin="miter"/></g></svg>`, 'black_queen': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15l10.5 2.5L33 15l-2 12.5L14 27.5z" fill="#000"/><path d="M12 15l10.5 12.5L33 15" fill="none"/><path d="M12 27.5l10.5 12.5L33 27.5" fill="none"/><circle cx="6" cy="12" r="2" fill="#000"/><circle cx="14" cy="9" r="2" fill="#000"/><circle cx="22.5" cy="8" r="2" fill="#000"/><circle cx="31" cy="9" r="2" fill="#000"/><circle cx="39" cy="12" r="2" fill="#000"/></g></svg>`, 'black_rook': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="#000" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13 11h19v5h-19zm0 5h19v13h-19zm-3 13h25v5h-25z"/><path d="M15 11V8h15v3"/></g></svg>`, 'black_bishop': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="#000" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 13.5c4-4 10-4 14 0 4 4 2 10-1.5 16.5-9 2-11-2.5-7-8.5C24.5 18 21 16 16 13.5z"/><path d="M24.5 29.5V39"/><path d="M15 39h15"/><path d="M19 19a3 3 0 100-4 3 3 0 000 4z"/></g></svg>`, 'black_knight': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 25.5c-2.5-3.5-2.5-11.5 3-15.5 5-4 11.5 0 11.5 5.5 0 2.5-1.5 5.5-3.5 7.5-3 3.5-8.5 4.5-8.5 4.5z" fill="#000"/><path d="M13.5 39.5s-2-20 8.5-24" fill="#000"/><path d="M13.5 39.5h15" stroke-linejoin="miter"/><path d="M22 39.5v-10.5" fill="#000"/></g></svg>`, 'black_pawn': `<svg xmlns="http://www.w3.org/2000/svg" class="piece black" viewBox="0 0 45 45"><g fill="#000" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22.5 39.5v-20m-10-10h20v20h-20z"/></g></svg>`} }
        };

        let board = [];
        let currentPlayer = 'white';
        let selectedPiece = null;
        let validMoves = [];
        let moveHistory = [];
        let capturedPieces = { white: [], black: [] };
        let isGameOver = false;
        
        const boardThemeKeys = ['marble', 'wood', 'emerald', 'oceanic'];
        const pieceThemeKeys = Object.keys(PIECE_THEMES);
        let currentBoardThemeIndex = 0;
        let currentPieceThemeIndex = 0;
        
        let castlingAvailability;

        function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

        function getCurrentPieceSet() { return PIECE_THEMES[pieceThemeKeys[currentPieceThemeIndex]].pieces; }

        function createInitialBoard() {
            const p = (color, type) => ({ color, type, hasMoved: false });
            board = [
                [p('black', 'rook'), p('black', 'knight'), p('black', 'bishop'), p('black', 'queen'), p('black', 'king'), p('black', 'bishop'), p('black', 'knight'), p('black', 'rook')],
                Array(8).fill(null).map(() => p('black', 'pawn')),
                Array(8).fill(null), Array(8).fill(null), Array(8).fill(null), Array(8).fill(null),
                Array(8).fill(null).map(() => p('white', 'pawn')),
                [p('white', 'rook'), p('white', 'knight'), p('white', 'bishop'), p('white', 'queen'), p('white', 'king'), p('white', 'bishop'), p('white', 'knight'), p('white', 'rook')]
            ];
            castlingAvailability = { white: { kingSide: true, queenSide: true }, black: { kingSide: true, queenSide: true } };
        }
        
        function renderBoard() {
            boardElement.innerHTML = '';
            const pieceSet = getCurrentPieceSet();
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const square = document.createElement('div');
                    square.className = `square ${(r + c) % 2 === 0 ? 'light' : 'dark'}`;
                    square.dataset.row = r;
                    square.dataset.col = c;
                    const piece = board[r][c];
                    if (piece) square.innerHTML = pieceSet[`${piece.color}_${piece.type}`];
                    boardElement.appendChild(square);
                }
            }
            highlightLastMove();
            renderCapturedPieces();
            addSquareListeners();
        }

        function renderCapturedPieces() {
            capturedWhiteContainer.innerHTML = '';
            capturedBlackContainer.innerHTML = '';
            const pieceSet = getCurrentPieceSet();
            const sortOrder = ['queen', 'rook', 'bishop', 'knight', 'pawn'];
            const sorter = (a, b) => sortOrder.indexOf(a.type) - sortOrder.indexOf(b.type);
            capturedPieces.white.sort(sorter).forEach(p => capturedWhiteContainer.innerHTML += pieceSet[`${p.color}_${p.type}`]);
            capturedPieces.black.sort(sorter).forEach(p => capturedBlackContainer.innerHTML += pieceSet[`${p.color}_${p.type}`]);
        }
        
        function addSquareListeners() { if(!isGameOver) document.querySelectorAll('.square').forEach(square => square.addEventListener('click', handleSquareClick)); }
        
        function handleSquareClick(event) {
            const square = event.currentTarget;
            const row = parseInt(square.dataset.row);
            const col = parseInt(square.dataset.col);
            if (selectedPiece) {
                if (validMoves.some(move => move[0] === row && move[1] === col)) {
                    movePiece(selectedPiece.row, selectedPiece.col, row, col);
                } else {
                    clearHighlights();
                    selectedPiece = null;
                    if (board[row][col]?.color === currentPlayer) selectPiece(row, col);
                }
            } else if (board[row][col]?.color === currentPlayer) {
                selectPiece(row, col);
            }
        }

        function selectPiece(row, col) {
            clearHighlights();
            validMoves = getLegalMoves(board[row][col], row, col);
            if(validMoves.length > 0) {
                selectedPiece = { piece: board[row][col], row, col };
                document.querySelector(`[data-row='${row}'][data-col='${col}']`).classList.add('selected');
                highlightValidMoves();
            }
        }

        function movePiece(fromRow, fromCol, toRow, toCol) {
            const moveData = {
                from: [fromRow, fromCol], to: [toRow, toCol],
                movedPiece: deepClone(board[fromRow][fromCol]),
                capturedPiece: board[toRow][toCol] ? deepClone(board[toRow][toCol]) : null,
                castlingAvailabilityBefore: deepClone(castlingAvailability)
            };
            
            const piece = board[fromRow][fromCol];
            if (moveData.capturedPiece) capturedPieces[currentPlayer].push(moveData.capturedPiece);
            if (piece.type === 'pawn' && Math.abs(fromRow - toRow) === 2) moveData.enPassantTarget = [(fromRow + toRow) / 2, fromCol];
            if (piece.type === 'pawn' && fromCol !== toCol && !moveData.capturedPiece) {
                const capturedRow = currentPlayer === 'white' ? toRow + 1 : toRow - 1;
                moveData.enPassantCapture = deepClone(board[capturedRow][fromCol]);
                capturedPieces[currentPlayer].push(moveData.enPassantCapture);
                board[capturedRow][fromCol] = null;
            }
            if (piece.type === 'king' && Math.abs(fromCol - toCol) === 2) {
                const rookFromCol = toCol > fromCol ? 7 : 0;
                const rookToCol = toCol > fromCol ? 5 : 3;
                board[toRow][rookToCol] = board[toRow][rookFromCol];
                board[toRow][rookFromCol] = null;
                if (board[toRow][rookToCol]) board[toRow][rookToCol].hasMoved = true;
            }
            if (piece.type === 'king') castlingAvailability[piece.color] = { kingSide: false, queenSide: false };
            if (piece.type === 'rook' && !piece.hasMoved) {
                const startRow = piece.color === 'white' ? 7 : 0;
                if (fromRow === startRow && fromCol === 0) castlingAvailability[piece.color].queenSide = false;
                if (fromRow === startRow && fromCol === 7) castlingAvailability[piece.color].kingSide = false;
            }
            board[toRow][toCol] = piece;
            board[fromRow][fromCol] = null;
            piece.hasMoved = true;
            moveHistory.push(moveData);
            if (piece.type === 'pawn' && (toRow === 0 || toRow === 7)) {
                promotePawn(toRow, toCol);
                return;
            }
            switchTurn();
        }
        
        function promotePawn(row, col) {
            promotionModal.style.display = 'flex';
            promotionChoices.innerHTML = '';
            const pieceSet = getCurrentPieceSet();
            ['queen', 'rook', 'bishop', 'knight'].forEach(type => {
                const choice = document.createElement('div');
                choice.innerHTML = pieceSet[`${currentPlayer}_${type}`];
                choice.addEventListener('click', () => {
                    board[row][col].type = type;
                    moveHistory.at(-1).promotion = type;
                    promotionModal.style.display = 'none';
                    switchTurn();
                });
                promotionChoices.appendChild(choice);
            });
        }

        function switchTurn() {
            currentPlayer = currentPlayer === 'white' ? 'black' : 'white';
            selectedPiece = null;
            renderBoard();
            updateGameStatus();
        }

        function clearHighlights() {
            document.querySelectorAll('.square.selected, .square.in-check').forEach(s => s.classList.remove('selected', 'in-check'));
            document.querySelectorAll('.valid-move-dot').forEach(dot => dot.remove());
        }
        
        function highlightValidMoves() { validMoves.forEach(([r, c]) => document.querySelector(`[data-row='${r}'][data-col='${c}']`)?.appendChild(document.createElement('div')).classList.add('valid-move-dot')); }
        
        function highlightLastMove() {
            document.querySelectorAll('.last-move').forEach(s => s.classList.remove('last-move'));
            if (moveHistory.length > 0) {
                const { from, to } = moveHistory.at(-1);
                document.querySelector(`[data-row='${from[0]}'][data-col='${from[1]}']`)?.classList.add('last-move');
                document.querySelector(`[data-row='${to[0]}'][data-col='${to[1]}']`)?.classList.add('last-move');
            }
        }
        
        function getPseudoLegalMoves(piece, r, c, currentBoard, currentCastling) {
            const moves = [];
            if (!piece) return moves;
            const color = piece.color;
            const add = (tr, tc) => { if (tr >= 0 && tr < 8 && tc >= 0 && tc < 8) { const t = currentBoard[tr][tc]; if (!t || t.color !== color) moves.push([tr, tc]); } };
            const addLine = (dr, dc) => { let tr = r + dr, tc = c + dc; while(tr >= 0 && tr < 8 && tc >= 0 && tc < 8) { const t = currentBoard[tr][tc]; if (t) { if(t.color !== color) moves.push([tr, tc]); break; } moves.push([tr, tc]); tr += dr; tc += dc; } };
            
            if (piece.type === 'pawn') {
                const dir = color === 'white' ? -1 : 1;
                const startRow = color === 'white' ? 6 : 1;
                if (r + dir >= 0 && r + dir < 8 && !currentBoard[r + dir][c]) {
                    moves.push([r + dir, c]);
                    if (r === startRow && !currentBoard[r + 2 * dir][c]) moves.push([r + 2 * dir, c]);
                }
                [-1, 1].forEach(cd => {
                    const tr = r + dir, tc = c + cd;
                    if (tr >= 0 && tr < 8 && tc >= 0 && tc < 8 && currentBoard[tr][tc] && currentBoard[tr][tc].color !== color) {
                        moves.push([tr, tc]);
                    }
                });
                const last = moveHistory.at(-1);
                if (last?.enPassantTarget && last.enPassantTarget[0] === r + dir && Math.abs(last.enPassantTarget[1] - c) === 1) {
                    moves.push(last.enPassantTarget);
                }
            } else if (piece.type === 'knight') {
                [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([dr,dc]) => add(r+dr, c+dc));
            } else if (['rook', 'bishop', 'queen'].includes(piece.type)) {
                const dirs = {rook: [[0,1],[0,-1],[1,0],[-1,0]], bishop: [[1,1],[1,-1],[-1,1],[-1,-1]], queen: [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]]};
                dirs[piece.type].forEach(dir => addLine(dir[0], dir[1]));
            } else if (piece.type === 'king') {
                [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([dr,dc]) => add(r+dr, c+dc));
                if (!piece.hasMoved) {
                    if (currentCastling[color].kingSide && !currentBoard[r][5] && !currentBoard[r][6] && currentBoard[r][7]?.type === 'rook' && !currentBoard[r][7].hasMoved) moves.push([r, 6]);
                    if (currentCastling[color].queenSide && !currentBoard[r][3] && !currentBoard[r][2] && !currentBoard[r][1] && currentBoard[r][0]?.type === 'rook' && !currentBoard[r][0].hasMoved) moves.push([r, 2]);
                }
            }
            return moves;
        }

        function isKingInCheck(kingColor, currentBoard) {
            let kingPos;
            for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) if (currentBoard[r][c]?.type === 'king' && currentBoard[r][c]?.color === kingColor) kingPos = [r, c];
            if (!kingPos) return true;
            const opponentColor = kingColor === 'white' ? 'black' : 'white';
            for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) {
                const piece = currentBoard[r][c];
                if (piece?.color === opponentColor) if (getPseudoLegalMoves(piece, r, c, currentBoard, castlingAvailability).some(m => m[0] === kingPos[0] && m[1] === kingPos[1])) return true;
            }
            return false;
        }

        function getLegalMoves(piece, r, c) {
            return getPseudoLegalMoves(piece, r, c, board, castlingAvailability).filter(move => {
                const tempBoard = deepClone(board);
                if (piece.type === 'king' && Math.abs(c - move[1]) === 2) {
                    const midCol = (c + move[1]) / 2;
                    tempBoard[r][midCol] = tempBoard[r][c];
                    tempBoard[r][c] = null;
                    if(isKingInCheck(piece.color, tempBoard)) return false;
                }
                tempBoard[move[0]][move[1]] = tempBoard[r][c];
                tempBoard[r][c] = null;
                return !isKingInCheck(piece.color, tempBoard);
            });
        }
        
        function hasAnyLegalMoves(color) {
            for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) if (board[r][c]?.color === color && getLegalMoves(board[r][c], r, c).length > 0) return true;
            return false;
        }

        function updateGameStatus() {
            undoButton.disabled = moveHistory.length === 0;
            clearHighlights();
            const inCheck = isKingInCheck(currentPlayer, board);
            if (!hasAnyLegalMoves(currentPlayer)) {
                isGameOver = true;
                boardElement.classList.add('game-over');
                statusElement.textContent = inCheck ? `¡Jaque Mate! Ganan las ${currentPlayer === 'white' ? 'Negras' : 'Blancas'}.` : "¡Tablas por Ahogado!";
            } else {
                isGameOver = false;
                boardElement.classList.remove('game-over');
                statusElement.textContent = `Turno de las ${currentPlayer === 'white' ? 'Blancas' : 'Negras'}${inCheck ? ' (¡Jaque!)' : ''}`;
                if (inCheck) {
                    for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) {
                        if (board[r][c]?.type === 'king' && board[r][c]?.color === currentPlayer) {
                            document.querySelector(`[data-row='${r}'][data-col='${c}']`).classList.add('in-check');
                        }
                    }
                }
            }
        }
        function undoLastMove() {
            if (moveHistory.length === 0) return;
            const lastMove = moveHistory.pop();
            const [fromR, fromC] = lastMove.from;
            const [toR, toC] = lastMove.to;
            board[fromR][fromC] = lastMove.movedPiece;
            board[toR][toC] = lastMove.capturedPiece;
            
            if(lastMove.capturedPiece) capturedPieces[currentPlayer === 'white' ? 'black' : 'white'].pop();
            if(lastMove.enPassantCapture){
                const capturedRow = currentPlayer === 'white' ? toR + 1 : toR - 1;
                board[capturedRow][toC] = lastMove.enPassantCapture;
                capturedPieces[currentPlayer === 'white' ? 'black' : 'white'].pop();
            }
            if (lastMove.movedPiece.type === 'king' && Math.abs(fromC - toC) === 2) {
                const rookFromCol = toC > fromC ? 5 : 3;
                const rookToCol = toC > fromC ? 7 : 0;
                board[fromR][rookToCol] = board[fromR][rookFromCol];
                board[fromR][rookFromCol] = null;
            }
            castlingAvailability = lastMove.castlingAvailabilityBefore;
            switchTurn();
        }

        function switchBoardTheme() {
            currentBoardThemeIndex = (currentBoardThemeIndex + 1) % boardThemeKeys.length;
            document.body.dataset.boardTheme = boardThemeKeys[currentBoardThemeIndex];
        }
        function switchPieceTheme() {
            currentPieceThemeIndex = (currentPieceThemeIndex + 1) % pieceThemeKeys.length;
            renderBoard();
            updateGameStatus();
        }
        
        function init() {
            const maestroPieces = PIECE_THEMES.maestro.pieces;
            maestroPieces.black_rook = maestroPieces.black_rook.replace('22.s5', '22.5');
            maestroPieces.white_king = maestroPieces.white_king.replace('12.s5', '12.5');
            const classicPieces = PIECE_THEMES.classic.pieces;
            classicPieces.white_queen = classicPieces.white_queen.replace('2.s5-4', '2.5-4');
            classicPieces.black_king = classicPieces.black_king.replace('10.s5', '10.5');
            classicPieces.black_bishop = classicPieces.black_bishop.replace('2.s5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z', '2.5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z');
            const neoPieces = PIECE_THEMES.neo.pieces;
            neoPieces.white_bishop = neoPieces.white_bishop.replace('24.s5', '24.5');

            document.body.dataset.boardTheme = boardThemeKeys[currentBoardThemeIndex];
            boardThemeSwitcher.addEventListener('click', switchBoardTheme);
            pieceThemeSwitcher.addEventListener('click', switchPieceTheme);
            undoButton.addEventListener('click', undoLastMove);
            createInitialBoard();
            renderBoard();
            updateGameStatus();
        }
        init();
    });
    </script>
</body>
</html>
