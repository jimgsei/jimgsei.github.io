<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Centros Educativos - Andalucía</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for a subtle highlight */
        .highlight {
            background-color: #fef9c3; /* A light yellow, similar to Tailwind's yellow-100 */
            padding: 2px 4px;
            border-radius: 4px;
        }
        /* Style for the custom dropdown */
        .dropdown:hover .dropdown-menu {
            display: block;
        }
        /* Hide scrollbar for the modal body but allow scrolling */
        .modal-body::-webkit-scrollbar {
            display: none;
        }
        .modal-body {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900 mb-2">
                <i class="bi bi-buildings-fill text-blue-600"></i> Buscador de Centros
            </h1>
            <p class="text-lg text-slate-600">Encuentra centros educativos en Andalucía</p>
        </header>

        <!-- Search Form -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                <div class="md:col-span-4">
                    <label for="searchTerm" class="block text-sm font-medium text-slate-700 mb-1">Nombre del centro</label>
                    <input type="text" id="searchTerm" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ej: IES Alborán">
                </div>
                <div class="md:col-span-3">
                    <label for="localidad" class="block text-sm font-medium text-slate-700 mb-1">Localidad</label>
                    <input type="text" id="localidad" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ej: Almería">
                </div>
                <div class="md:col-span-3">
                    <label for="provincia" class="block text-sm font-medium text-slate-700 mb-1">Provincia</label>
                    <select id="provincia" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="">Todas</option>
                        <option value="Almería">Almería</option>
                        <option value="Cádiz">Cádiz</option>
                        <option value="Córdoba">Córdoba</option>
                        <option value="Granada">Granada</option>
                        <option value="Huelva">Huelva</option>
                        <option value="Jaén">Jaén</option>
                        <option value="Málaga">Málaga</option>
                        <option value="Sevilla">Sevilla</option>
                    </select>
                </div>
                <div class="md:col-span-2 flex items-end">
                    <button id="searchBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out flex items-center justify-center">
                        <i class="bi bi-search mr-2"></i> Buscar
                    </button>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex items-center">
                    <input id="exactMatch" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                    <label for="exactMatch" class="ml-2 block text-sm text-slate-900">Coincidencia exacta de nombre y localidad</label>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div>
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <h5 id="resultsCount" class="text-slate-700 font-semibold mb-2 md:mb-0">Cargando datos...</h5>
                <div class="relative dropdown">
                    <button class="inline-flex justify-center w-full rounded-md border border-slate-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Ordenar por
                        <i class="bi bi-chevron-down -mr-1 ml-2 h-5 w-5"></i>
                    </button>
                    <div id="sortDropdown" class="dropdown-menu hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                        <div class="py-1" role="menu" aria-orientation="vertical">
                            <a href="#" class="sort-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" data-sort="name-asc">Nombre (A-Z)</a>
                            <a href="#" class="sort-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" data-sort="name-desc">Nombre (Z-A)</a>
                            <a href="#" class="sort-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" data-sort="location-asc">Localidad (A-Z)</a>
                            <a href="#" class="sort-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" data-sort="location-desc">Localidad (Z-A)</a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="loadingSpinner" class="text-center py-10 hidden">
                <div role="status">
                    <svg aria-hidden="true" class="inline w-10 h-10 text-slate-200 animate-spin fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                        <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5424 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                    </svg>
                    <span class="sr-only">Cargando...</span>
                </div>
                <p class="mt-4 text-slate-600">Buscando centros educativos...</p>
            </div>

            <div id="resultsContainer" class="grid grid-cols-1 gap-4"></div>

            <div id="noResults" class="hidden bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg" role="alert">
                <p class="font-bold">Sin resultados</p>
                <p>No se encontraron centros que coincidan con tu búsqueda. Prueba con otros términos.</p>
            </div>
        </div>
    </div>

    <!-- Modal for details -->
    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div id="modalContent" class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center p-4 border-b border-slate-200">
                <h5 id="detailsModalLabel" class="text-xl font-bold text-slate-900">Detalles del Centro</h5>
                <button id="closeModalBtn" class="text-slate-500 hover:text-slate-800">
                    <i class="bi bi-x-lg text-2xl"></i>
                </button>
            </div>
            <div id="modalBody" class="p-6 overflow-y-auto">
                <!-- Details will be inserted here -->
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-200 rounded-b-2xl text-right">
                <button id="closeModalFooterBtn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 py-6 bg-white border-t border-slate-200">
        <div class="container mx-auto text-center text-slate-600">
            <p>Datos proporcionados por la <a href="https://www.juntadeandalucia.es/datosabiertos/" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-600 hover:underline">Junta de Andalucía</a>.</p>
            <p class="text-sm text-slate-500">Última actualización de datos: <span id="updateDate"></span></p>
        </footer>

    <!-- PapaParse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Element References ---
            const searchBtn = document.getElementById('searchBtn');
            const searchTermInput = document.getElementById('searchTerm');
            const localidadInput = document.getElementById('localidad');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultsContainer = document.getElementById('resultsContainer');
            const noResults = document.getElementById('noResults');
            const resultsCount = document.getElementById('resultsCount');
            const sortOptions = document.querySelectorAll('.sort-option');
            const modal = document.getElementById('detailsModal');
            const modalContent = document.getElementById('modalContent');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const closeModalFooterBtn = document.getElementById('closeModalFooterBtn');

            // --- Global State ---
            let allCenters = [];
            let currentSort = 'name-asc';

            // --- Initial Setup ---
            document.getElementById('updateDate').textContent = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            loadData();

            // --- Event Listeners ---
            searchBtn.addEventListener('click', searchCenters);
            searchTermInput.addEventListener('keyup', e => e.key === 'Enter' && searchCenters());
            localidadInput.addEventListener('keyup', e => e.key === 'Enter' && searchCenters());

            sortOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentSort = this.getAttribute('data-sort');
                    document.querySelector('.dropdown-menu').classList.add('hidden');
                    const filtered = filterCenters();
                    displayResults(filtered);
                });
            });

            // Modal close events
            [closeModalBtn, closeModalFooterBtn, modal].forEach(el => {
                el.addEventListener('click', (e) => {
                    if (e.target === modal || e.target.closest('button')) {
                        hideModal();
                    }
                });
            });


            // --- Core Functions ---

            function loadData() {
                loadingSpinner.classList.remove('hidden');
                const csvUrl = 'https://www.juntadeandalucia.es/datosabiertos/portal/dataset/e039df22-4b82-4d0d-9884-0ab5952e24e4/resource/15aabed2-eec3-4b99-a027-9af5e27c9cac/download/da_centros.csv';
                
                Papa.parse(csvUrl, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    encoding: "UTF-8", // Explicitly set to UTF-8 for consistency
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            console.error("Errors during parsing:", results.errors);
                        }
                        
                        allCenters = results.data.map(center => {
                            // Sanitize coordinate data
                            if (center.N_LATITUD) center.N_LATITUD = center.N_LATITUD.replace(',', '.');
                            if (center.N_LONGITUD) center.N_LONGITUD = center.N_LONGITUD.replace(',', '.');
                            return center;
                        });
                        loadingSpinner.classList.add('hidden');
                        
                        resultsCount.textContent = `${allCenters.length.toLocaleString('es-ES')} centros en Andalucía. Utiliza los filtros para buscar.`;
                    },
                    error: function(error) {
                        console.error('Error loading or parsing data:', error);
                        loadingSpinner.classList.add('hidden');
                        resultsContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert"><p class="font-bold">Error de Carga</p><p>No se pudieron cargar los datos de los centros. Por favor, intenta recargar la página más tarde.</p></div>`;
                    }
                });
            }

            function searchCenters() {
                loadingSpinner.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
                noResults.classList.add('hidden');
                
                setTimeout(() => {
                    const filtered = filterCenters();
                    displayResults(filtered);
                    loadingSpinner.classList.add('hidden');
                    resultsContainer.classList.remove('hidden');
                }, 100);
            }

            function filterCenters() {
                const searchTerm = document.getElementById('searchTerm').value.toLowerCase().trim();
                const localidad = document.getElementById('localidad').value.toLowerCase().trim();
                const provincia = document.getElementById('provincia').value;
                const exactMatch = document.getElementById('exactMatch').checked;

                return allCenters.filter(center => {
                    // FIX: Make province comparison case-insensitive
                    if (provincia && center.D_PROVINCIA.toUpperCase() !== provincia.toUpperCase()) {
                        return false;
                    }

                    const centerLocalidad = (center.D_LOCALIDAD || '').toLowerCase();
                    if (localidad) {
                        if (exactMatch ? centerLocalidad !== localidad : !centerLocalidad.includes(localidad)) {
                            return false;
                        }
                    }

                    const centerName = (center.D_DENOMINA_COMPLETA || center.D_ESPECIFICA || center.D_DENOMINA || '').toLowerCase();
                    if (searchTerm) {
                        if (exactMatch ? centerName !== searchTerm : !centerName.includes(searchTerm)) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }

            function displayResults(centers) {
                const sortedCenters = sortCenters(centers, currentSort);
                
                resultsCount.textContent = `${sortedCenters.length.toLocaleString('es-ES')} resultados encontrados`;
                resultsContainer.innerHTML = '';

                if (sortedCenters.length === 0) {
                    if (document.getElementById('searchTerm').value || document.getElementById('localidad').value || document.getElementById('provincia').value) {
                       noResults.classList.remove('hidden');
                    }
                    return;
                }
                noResults.classList.add('hidden');

                const searchTerm = document.getElementById('searchTerm').value;
                const localidadTerm = document.getElementById('localidad').value;
                const exactMatch = document.getElementById('exactMatch').checked;

                sortedCenters.forEach(center => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl shadow-md overflow-hidden p-5 transition-transform duration-300 hover:scale-[1.02] hover:shadow-xl';
                    
                    const name = center.D_DENOMINA_COMPLETA || center.D_ESPECIFICA || center.D_DENOMINA || 'Centro sin nombre';
                    const tipo = center.D_TIPO === 'Público' 
                        ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Público</span>`
                        : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">Privado/Concertado</span>`;
                    
                    const localidad = center.D_LOCALIDAD || 'Localidad desconocida';
                    const provincia = center.D_PROVINCIA || 'Provincia desconocida';
                    
                    const displayName = exactMatch ? name : highlightTerm(name, searchTerm);
                    const displayLocalidad = exactMatch ? localidad : highlightTerm(localidad, localidadTerm);

                    card.innerHTML = `
                        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                            <div class="flex-grow">
                                <h6 class="text-lg font-bold text-slate-900">${displayName}</h6>
                                <p class="text-sm text-slate-600 mt-1"><i class="bi bi-geo-alt-fill mr-2 text-slate-400"></i>${displayLocalidad}, ${provincia}</p>
                                <p class="text-sm text-slate-600 mt-1"><i class="bi bi-building mr-2 text-slate-400"></i>${center.D_DENOMINA || 'Tipo no especificado'} ${tipo}</p>
                            </div>
                            <button class="flex-shrink-0 bg-blue-50 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-100 transition duration-300 w-full sm:w-auto" onclick="window.showDetails('${center.codigo}')">
                                <i class="bi bi-info-circle mr-2"></i>Ver Detalles
                            </button>
                        </div>
                    `;
                    resultsContainer.appendChild(card);
                });
            }

            function highlightTerm(text, term) {
                if (!term || !text) return text;
                const regex = new RegExp(`(${term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                return text.replace(regex, `<span class="highlight">$1</span>`);
            }

            function sortCenters(centers, sortOption) {
                return [...centers].sort((a, b) => {
                    const nameA = (a.D_DENOMINA_COMPLETA || a.D_ESPECIFICA || a.D_DENOMINA || '').toLowerCase();
                    const nameB = (b.D_DENOMINA_COMPLETA || b.D_ESPECIFICA || b.D_DENOMINA || '').toLowerCase();
                    const locationA = (a.D_LOCALIDAD || '').toLowerCase();
                    const locationB = (b.D_LOCALIDAD || '').toLowerCase();

                    switch(sortOption) {
                        case 'name-asc': return nameA.localeCompare(nameB, 'es');
                        case 'name-desc': return nameB.localeCompare(nameA, 'es');
                        case 'location-asc': return locationA.localeCompare(locationB, 'es') || nameA.localeCompare(nameB, 'es');
                        case 'location-desc': return locationB.localeCompare(locationA, 'es') || nameA.localeCompare(nameB, 'es');
                        default: return 0;
                    }
                });
            }
            
            function showModal() {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modalContent.classList.remove('scale-95');
                }, 10); // Start transition after display is set
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }

            function hideModal() {
                modal.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }, 300); // Wait for transition to finish
                document.body.style.overflow = ''; // Restore background scrolling
            }

            // Make showDetails globally accessible for the inline onclick handler
            window.showDetails = function(codigo) {
                const center = allCenters.find(c => c.codigo === codigo);
                if (!center) return;

                const modalTitle = document.getElementById('detailsModalLabel');
                const modalBody = document.getElementById('modalBody');
                
                const name = center.D_DENOMINA_COMPLETA || center.D_ESPECIFICA || center.D_DENOMINA || 'Centro sin nombre';
                const tipo = center.D_TIPO === 'Público' 
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Público</span>`
                    : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">Privado/Concertado</span>`;

                modalTitle.textContent = name;
                
                let detailsHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h6 class="font-bold text-lg mb-3 text-slate-800 border-b pb-2">Información General</h6>
                            <p class="mb-2"><strong>Tipo:</strong> ${center.D_DENOMINA || 'No especificado'} ${tipo}</p>
                            <p class="mb-2"><strong>Dirección:</strong> ${center.D_DOMICILIO || 'No especificada'}</p>
                            <p class="mb-2"><strong>Localidad:</strong> ${center.D_LOCALIDAD || 'No especificada'}</p>
                            <p class="mb-2"><strong>Código Postal:</strong> ${center.C_POSTAL || 'No especificado'}</p>
                            <p><strong>Provincia:</strong> ${center.D_PROVINCIA || 'No especificada'}</p>
                            
                            <h6 class="font-bold text-lg mt-6 mb-3 text-slate-800 border-b pb-2">Contacto</h6>
                            <p class="mb-2"><strong>Teléfono:</strong> ${center.N_TELEFONO ? `<a href="tel:${center.N_TELEFONO}" class="text-blue-600 hover:underline">${center.N_TELEFONO}</a>` : 'No especificado'}</p>
                            <p><strong>Email:</strong> ${center.Correo_e ? `<a href="mailto:${center.Correo_e}" class="text-blue-600 hover:underline">${center.Correo_e}</a>` : 'No especificado'}</p>
                        </div>
                        <div>
                            <h6 class="font-bold text-lg mb-3 text-slate-800 border-b pb-2">Ubicación</h6>
                `;

                if (center.N_LATITUD && center.N_LONGITUD) {
                    detailsHtml += `
                        <div class="h-64 md:h-full w-full rounded-lg overflow-hidden border border-slate-200" id="map-${center.codigo}"></div>
                        <small class="text-slate-500 mt-1 block">Coordenadas: ${parseFloat(center.N_LATITUD).toFixed(5)}, ${parseFloat(center.N_LONGITUD).toFixed(5)}</small>
                    `;
                } else {
                    detailsHtml += `<div class="h-64 flex items-center justify-center bg-slate-100 rounded-lg"><p class="text-slate-500">Ubicación no disponible</p></div>`;
                }
                detailsHtml += `</div></div>`;
                modalBody.innerHTML = detailsHtml;
                
                showModal();

                if (center.N_LATITUD && center.N_LONGITUD) {
                    setTimeout(() => {
                        initMap(`map-${center.codigo}`, parseFloat(center.N_LATITUD), parseFloat(center.N_LONGITUD));
                    }, 100); // Delay map initialization slightly
                }
            }

            function initMap(mapId, lat, lng) {
                const mapContainer = document.getElementById(mapId);
                if (!mapContainer) return;
                mapContainer.innerHTML = `
                    <iframe 
                        width="100%" height="100%" frameborder="0" scrolling="no" 
                        src="https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.005},${lat-0.005},${lng+0.005},${lat+0.005}&layer=mapnik&marker=${lat},${lng}"
                        class="rounded-lg">
                    </iframe>`;
            }
        });
    </script>
</body>
</html>

