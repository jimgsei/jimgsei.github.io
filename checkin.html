<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Etapa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    [v-cloak] { display: none; }
  </style>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gray-100 min-h-screen" v-cloak id="app">
  <div class="container mx-auto max-w-lg p-5 pt-10">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full">
      <div v-if="!submitted">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">Registro de Etapa</h1>
        <h2 class="text-xl font-semibold text-center text-blue-700 mb-6">{{ stageName }}</h2>
        <p class="text-gray-600 mb-4 text-center">{{ stageInfo }}</p>
        
        <form @submit.prevent="submitDorsal">
          <div class="mb-4">
            <label for="dorsal" class="block text-sm font-medium text-gray-700 mb-1">Tu Nº de Dorsal</label>
            <input type="number" id="dorsal" v-model="dorsal" class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm text-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
          </div>
          
          <p v-if="submitError" class="text-sm text-red-600 mb-4">{{ submitError }}</p>
          
          <button type="submit" :disabled="isLoading" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out text-lg font-medium"
                  :class="{ 'opacity-50 cursor-not-allowed': isLoading }">
            <span v-if="!isLoading">Registrar Paso</span>
            <span v-else class="flex items-center justify-center">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Registrando...
            </span>
          </button>
        </form>
      </div>

      <div v-if="submitted">
        <h2 class="text-2xl font-bold text-center text-green-600 mb-4">¡Registro Exitoso!</h2>
        <p class="text-lg text-gray-700 text-center mb-6">{{ message }}</p>
        
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Tu Progreso</h3>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-600">Etapas Completadas:</span>
              <span class="font-bold text-gray-900">{{ status.completedCount }} / {{ status.totalCount }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Próxima Etapa:</span>
              <span class="font-bold text-blue-700">{{ status.nextStage }}</span>
            </div>
          </div>
        </div>

        <button @click="resetForm" class="w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 mt-6 transition">
          Registrar otro dorsal
        </button>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, onMounted } = Vue

    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzeyhPze8vJKaP5Qq6FAHCrM0RnOyKJ-u9qAxHzJ4xmj9SjlTfmXzK99OCk-lh6mAS-/exec";
    
    createApp({
      setup() {
        const dorsal = ref('')
        const isLoading = ref(false)
        const submitError = ref('')
        const submitted = ref(false)
        const message = ref('')
        const status = ref({ completedCount: 0, totalCount: 0, nextStage: '---' })
        
        const stageId = ref('')
        const stageName = ref('Cargando etapa...')
        const stageInfo = ref('')

        onMounted(() => {
          const urlParams = new URLSearchParams(window.location.search)
          stageId.value = urlParams.get('stage') || ''
          stageName.value = urlParams.get('name') || 'Etapa Desconocida'
          stageInfo.value = urlParams.get('info') || ''
          
          if (!stageId.value) {
            submitError.value = "Error: No se ha especificado una etapa."
          }
        })
        
        const submitDorsal = () => {
          if (APPS_SCRIPT_URL.includes("PEGA_AQUI")) {
             submitError.value = "Error: La URL de Apps Script no está configurada."
             return
          }
          if (!dorsal.value) {
            submitError.value = "Por favor, introduce un dorsal."
            return
          }
          isLoading.value = true
          submitError.value = ''

          const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());

          window[callbackName] = (data) => {
            if (data.success) {
              message.value = data.message
              status.value = data.status
              submitted.value = true
            } else {
              submitError.value = data.message
            }
            
            isLoading.value = false
            
            document.head.removeChild(script);
            delete window[callbackName];
          };

          const params = new URLSearchParams({
            action: 'register',
            dorsal: dorsal.value,
            stageId: stageId.value,
            callback: callbackName
          });

          const script = document.createElement('script');
          script.src = `${APPS_SCRIPT_URL}?${params.toString()}`;
          script.onerror = () => {
             submitError.value = "Error fatal de conexión. ¿Está la URL de Apps Script bien implementada?";
             isLoading.value = false;
          };
          document.head.appendChild(script);
        }
        
        const resetForm = () => {
          submitted.value = false
          dorsal.value = ''
          submitError.value = ''
          message.value = ''
          status.value = { completedCount: 0, totalCount: 0, nextStage: '---' }
        }

        return {
          dorsal,
          isLoading,
          submitError,
          submitted,
          message,
          status,
          stageName,
          stageInfo,
          submitDorsal,
          resetForm
        }
      }
    }).mount('#app')
  </script>
</body>
</html>
