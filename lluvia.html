<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Meteo España</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; background: #111; font-family: 'Inter', system-ui, sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; background: #1a1a1a; }
        
        /* Ocultar atribuciones de Leaflet y otros textos no deseados */
        .leaflet-control-attribution { display: none !important; }
        
        /* Estilos Slider Personalizado */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus { outline: none; }
        
        /* Track del slider */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px; /* Más fino */
            cursor: pointer;
            border-radius: 2px;
            background: #333; /* Fondo oscuro por defecto */
        }
        
        /* Thumb (el botón que se mueve) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #fff;
            border: none;
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            transition: transform 0.1s;
        }
        
        /* Paneles flotantes oscuros */
        .dark-panel {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Gradiente específico para la leyenda de lluvia (Universal Blue) */
        .legend-gradient {
            /* Colores aproximados del mapa de RainViewer (Scheme 2) */
            background: linear-gradient(to right, 
                rgba(0,0,0,0) 0%, 
                #85F1FF 10%, /* Llovizna */
                #0095FF 40%, /* Moderada */
                #0033FF 70%, /* Fuerte */
                #FF00FF 100% /* Extrema */
            );
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <!-- Título Minimalista -->
    <div class="absolute top-6 left-6 z-[500]">
        <h1 class="text-white font-bold text-2xl tracking-tight drop-shadow-md">Radar <span class="text-blue-400">España</span></h1>
        <div id="loading-indicator" class="text-[10px] text-blue-300 font-medium mt-1 flex items-center">
            <span class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse mr-2"></span>
            Sincronizando satélite...
        </div>
    </div>

    <!-- Panel Inferior: Controles + Leyenda -->
    <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 w-[90%] max-w-2xl z-[500] dark-panel rounded-2xl p-3 shadow-2xl">
        
        <!-- Fila Superior: Botón Play, Hora y Etiquetas -->
        <div class="flex items-center justify-between mb-3 px-1">
            
            <div class="flex items-center gap-4">
                <!-- Botón Play/Pause -->
                <button id="play-pause-btn" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors text-white focus:outline-none">
                    <svg id="play-icon" class="w-4 h-4 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="pause-icon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>

                <!-- Hora Grande -->
                <div id="timestamp-label" class="text-lg font-mono font-bold text-white tracking-wider">--:--</div>
            </div>

            <!-- Badges de Estado -->
            <div class="flex items-center gap-2">
                <span id="live-badge" class="hidden px-2 py-0.5 rounded text-[10px] font-bold bg-blue-500/20 text-blue-300 border border-blue-500/30 tracking-wider">AHORA</span>
                <span id="forecast-badge" class="hidden px-2 py-0.5 rounded text-[10px] font-bold bg-purple-500/20 text-purple-300 border border-purple-500/30 tracking-wider">PREDICCIÓN</span>
            </div>
        </div>

        <!-- Slider de Tiempo -->
        <div class="relative w-full h-6 flex items-center px-1 group">
            <!-- Marcador "Ahora" -->
            <div id="now-marker" class="absolute top-1 w-px h-4 bg-white/50 z-10 pointer-events-none hidden"></div>
            
            <input type="range" id="time-slider" min="0" max="0" value="0" class="relative z-20">
        </div>

        <!-- Leyenda de Intensidad (mm/h) -->
        <div class="mt-3 border-t border-white/10 pt-3 flex flex-col items-center">
            <div class="w-full h-2 rounded-full legend-gradient mb-1 opacity-90"></div>
            <div class="w-full flex justify-between text-[9px] text-gray-400 font-medium px-1">
                <span>0 mm</span>
                <span>2 mm</span>
                <span>5 mm</span>
                <span>10 mm</span>
                <span>50+ mm</span>
            </div>
        </div>

    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        // --- Configuración ---
        const mapCenter = [40.4168, -3.7038]; // Madrid
        const initialZoom = 6;
        const animationSpeed = 250; // Más rápido para fluidez
        
        // --- Variables de Estado ---
        let timestamps = [];
        let radarLayers = {};
        let currentTimestampIndex = 0;
        let isPlaying = false;
        let animationInterval = null;
        let apiData = null;
        let pastCount = 0;

        // --- DOM Elements ---
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const slider = document.getElementById('time-slider');
        const timeLabel = document.getElementById('timestamp-label');
        const liveBadge = document.getElementById('live-badge');
        const forecastBadge = document.getElementById('forecast-badge');
        const loadingIndicator = document.getElementById('loading-indicator');
        const nowMarker = document.getElementById('now-marker');

        // --- Inicializar Mapa Oscuro ---
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false // Oculta atribución por configuración
        }).setView(mapCenter, initialZoom);

        // Mapa Base: CartoDB Dark Matter (Sin etiquetas o con etiquetas sutiles)
        // Usamos la versión con etiquetas (dark_all) para ver nombres, pero es oscura.
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd'
        }).addTo(map);

        // Zoom Control Minimalista
        L.control.zoom({ position: 'topright' }).addTo(map);

        // --- Lógica del Radar ---

        async function fetchRadarData() {
            try {
                const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                apiData = await response.json();
                
                let past = apiData.radar.past || [];
                let nowcast = apiData.radar.nowcast || [];
                
                pastCount = past.length;
                timestamps = [...past, ...nowcast].sort((a, b) => a.time - b.time);

                if (timestamps.length > 0) {
                    setupSlider();
                    showLayer(pastCount - 1); 
                    loadingIndicator.style.opacity = '0'; // Fade out loading
                }
            } catch (error) {
                console.error(error);
                loadingIndicator.textContent = "Error de red";
            }
        }

        function getLayerUrl(ts) {
            // Color 2 (Universal Blue) va bien con el modo oscuro
            // Smooth 1
            return `${apiData.host}${ts.path}/256/{z}/{x}/{y}/2/1_1.png`;
        }

        function setupSlider() {
            slider.min = 0;
            slider.max = timestamps.length - 1;
            slider.value = timestamps.length - 1;
            
            // Calcular posición del presente
            const percentNow = ((pastCount - 1) / (timestamps.length - 1)) * 100;
            
            // Dibujar la barra del slider con gradiente CSS
            // Azul tenue para pasado -> Morado brillante para futuro
            const trackGradient = `linear-gradient(to right, 
                #3b82f6 0%, 
                #3b82f6 ${percentNow}%, 
                #a855f7 ${percentNow}%, 
                #a855f7 100%)`;
            
            slider.style.background = trackGradient;
            
            // Marcador visual
            nowMarker.style.left = `${percentNow}%`;
            nowMarker.classList.remove('hidden');

            slider.addEventListener('input', (e) => {
                pauseAnimation();
                showLayer(parseInt(e.target.value));
            });
        }

        function showLayer(index) {
            if (index < 0 || index >= timestamps.length) return;
            
            currentTimestampIndex = index;
            slider.value = index;

            // Hora
            const tsData = timestamps[index];
            const date = new Date(tsData.time * 1000);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            timeLabel.textContent = `${hours}:${minutes}`;

            // Badges
            liveBadge.classList.add('hidden');
            forecastBadge.classList.add('hidden');

            if (index === pastCount - 1) {
                liveBadge.classList.remove('hidden');
            } else if (index >= pastCount) {
                forecastBadge.classList.remove('hidden');
            }

            // Renderizar Capa
            const layerKey = tsData.time;
            
            // Precarga agresiva de la siguiente imagen si estamos reproduciendo
            if (isPlaying && index < timestamps.length - 1) {
                const nextKey = timestamps[index+1].time;
                if(!radarLayers[nextKey]) {
                     radarLayers[nextKey] = L.tileLayer(getLayerUrl(timestamps[index+1]), {
                        tileSize: 256, opacity: 0, zIndex: 10
                    }).addTo(map);
                }
            }

            if (!radarLayers[layerKey]) {
                radarLayers[layerKey] = L.tileLayer(getLayerUrl(tsData), {
                    tileSize: 256,
                    opacity: 0,
                    zIndex: 10
                }).addTo(map);
            }

            const activeLayer = radarLayers[layerKey];
            activeLayer.setOpacity(0.9); // Alta opacidad para contraste con mapa oscuro

            // Ocultar resto
            Object.keys(radarLayers).forEach(key => {
                if (parseInt(key) !== layerKey) {
                    if (radarLayers[key]) {
                        radarLayers[key].setOpacity(0);
                    }
                }
            });
            
            // Limpieza ligera
            if (Object.keys(radarLayers).length > 25) {
                const keys = Object.keys(radarLayers).map(Number).sort((a,b)=>a-b);
                // Eliminar las más lejanas al índice actual
                keys.forEach(key => {
                     if (Math.abs(key - layerKey) > 3600) { // > 1 hora de diferencia
                        map.removeLayer(radarLayers[key]);
                        delete radarLayers[key];
                     }
                });
            }
        }

        // --- Animación ---
        function toggleAnimation() {
            isPlaying ? pauseAnimation() : startAnimation();
        }

        function startAnimation() {
            isPlaying = true;
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
            
            if (currentTimestampIndex >= timestamps.length - 1) currentTimestampIndex = 0;

            animationInterval = setInterval(() => {
                currentTimestampIndex++;
                if (currentTimestampIndex >= timestamps.length) currentTimestampIndex = 0;
                showLayer(currentTimestampIndex);
            }, animationSpeed);
        }

        function pauseAnimation() {
            isPlaying = false;
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            clearInterval(animationInterval);
        }

        playPauseBtn.addEventListener('click', toggleAnimation);

        // Iniciar
        fetchRadarData();
        setInterval(fetchRadarData, 300000); // Refresco cada 5min

    </script>
</body>
</html>


