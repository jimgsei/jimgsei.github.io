<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radar Meteo Pro + Forecast</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; background: #0b0f19; font-family: 'Inter', system-ui, sans-serif; color: white; }
        #map { height: 100%; width: 100%; z-index: 0; background: #0b0f19; }
        .leaflet-control-attribution { display: none !important; }
        
        /* Paneles de Cristal Oscuro */
        .glass-panel { background: rgba(11, 15, 25, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-solid { background: #0b0f19; }

        /* Slider Custom */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; border-radius: 2px; background: #334155; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -5px; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); transition: transform 0.1s; border: 2px solid white; }
        
        .legend-gradient { background: linear-gradient(to right, rgba(0,0,0,0) 0%, #00d4ff 20%, #0066ff 50%, #8000ff 80%, #ff00ff 100%); }

        /* Animaciones Sidebar */
        #weather-sidebar { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); transform: translateX(100%); }
        #weather-sidebar.open { transform: translateX(0); }

        /* Scrollbar oculta pero funcional */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .search-box { transition: width 0.3s ease; width: 40px; }
        .search-box.expanded { width: 240px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <!-- Título -->
    <div class="absolute top-6 left-6 z-[400] pointer-events-none">
        <h1 class="text-slate-100 font-bold text-2xl tracking-tight drop-shadow-xl flex items-center gap-2">
            <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Radar <span class="text-blue-500">Pro</span>
        </h1>
    </div>

    <!-- Buscador y Localización (Top Right) -->
    <div class="absolute top-6 right-6 z-[500] flex flex-col items-end gap-3 transition-all duration-300" id="top-controls">
        <div id="search-container" class="glass-panel h-10 rounded-full flex items-center overflow-hidden search-box relative">
            <input type="text" id="search-input" placeholder="Buscar ciudad..." class="w-full h-full bg-transparent border-none text-sm text-white px-4 focus:outline-none placeholder-gray-500 opacity-0 transition-opacity duration-300 absolute left-0 top-0 pl-3 pr-10 z-10" disabled>
            <button id="search-btn" class="absolute right-0 top-0 h-10 w-10 flex items-center justify-center text-gray-300 hover:text-white z-20 hover:bg-white/5 rounded-full">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </button>
        </div>
        
        <button id="locate-btn" class="glass-panel w-10 h-10 rounded-full flex items-center justify-center text-gray-300 hover:text-white hover:bg-white/10 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>

        <button id="toggle-sidebar-btn" class="glass-panel w-10 h-10 rounded-full flex items-center justify-center text-blue-400 hover:text-blue-300 hover:bg-white/10 transition-colors hidden">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </div>

    <!-- Sidebar de Predicción -->
    <div id="weather-sidebar" class="absolute top-0 right-0 h-full w-80 glass-solid border-l border-white/10 z-[600] shadow-2xl flex flex-col p-6 overflow-hidden">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h2 id="city-name" class="text-2xl font-bold text-white leading-tight">Cargando...</h2>
                <p id="city-coords" class="text-xs text-gray-500 font-mono mt-1">--</p>
            </div>
            <button id="close-sidebar" class="text-gray-500 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Current Weather -->
        <div class="mb-8">
            <div class="flex items-center gap-4">
                <div id="current-icon" class="w-16 h-16 text-blue-400"></div>
                <div>
                    <div id="current-temp" class="text-5xl font-bold tracking-tighter">--°</div>
                    <div id="current-desc" class="text-sm text-gray-400 capitalize">--</div>
                </div>
            </div>
            <!-- Wind and Rain Row -->
            <div class="flex items-center gap-6 mt-4 pt-4 border-t border-white/10">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center">
                        <svg id="wind-arrow" class="w-4 h-4 text-blue-300 transform transition-transform duration-700" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                    </div>
                    <div>
                        <div id="current-wind" class="text-sm font-bold">--</div>
                        <div class="text-[10px] text-gray-500 uppercase">Viento</div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-blue-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                    </div>
                    <div>
                        <div id="current-rain" class="text-sm font-bold">--</div>
                        <div class="text-[10px] text-gray-500 uppercase">Lluvia</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto no-scrollbar">
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3">24 Horas</h3>
            <div id="hourly-container" class="flex gap-3 overflow-x-auto no-scrollbar pb-4 mb-6">
                <!-- JS Injected -->
            </div>

            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3">7 Días</h3>
            <div id="daily-container" class="space-y-2">
                <!-- JS Injected -->
            </div>
        </div>
    </div>

    <!-- Controles de Reproducción -->
    <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 w-[92%] max-w-2xl z-[500] glass-panel rounded-2xl p-4 shadow-2xl">
        <div class="flex items-center justify-between mb-4 px-1">
            <div class="flex items-center gap-4">
                <button id="play-btn" class="w-10 h-10 rounded-full bg-blue-600 hover:bg-blue-500 flex items-center justify-center transition-colors text-white shadow-lg shadow-blue-900/50">
                    <svg id="play-icon" class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="pause-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <div id="time-display" class="text-xl font-mono font-bold text-white tracking-wider">--:--</div>
            </div>
            <div class="flex items-center gap-2">
                <span id="badge-live" class="hidden px-2 py-0.5 rounded text-[10px] font-bold bg-blue-500/20 text-blue-300 border border-blue-500/30 tracking-wider">EN VIVO</span>
            </div>
        </div>

        <div class="relative w-full h-8 flex items-center px-1 group">
            <div id="now-marker" class="absolute top-2 w-0.5 h-4 bg-white/40 z-10 pointer-events-none hidden"></div>
            <input type="range" id="slider" min="0" max="0" value="0" class="relative z-20">
        </div>

        <div class="mt-4 border-t border-white/5 pt-3 flex flex-col items-center">
            <div class="w-full h-1.5 rounded-full legend-gradient mb-1 opacity-80"></div>
            <div class="w-full flex justify-between text-[9px] text-slate-400 font-medium px-1 uppercase tracking-widest">
                <span>0mm</span>
                <span>2mm</span>
                <span>10mm</span>
                <span>50mm+</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([40.4168, -3.7038], 6);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, subdomains: 'abcd' }).addTo(map);

        let timestamps = [], layers = {}, currentIndex = 0, isPlaying = false, interval = null, apiData = null, pastLen = 0;
        
        const els = {
            play: document.getElementById('play-btn'),
            playIcon: document.getElementById('play-icon'),
            pauseIcon: document.getElementById('pause-icon'),
            slider: document.getElementById('slider'),
            time: document.getElementById('time-display'),
            live: document.getElementById('badge-live'),
            marker: document.getElementById('now-marker'),
            searchBtn: document.getElementById('search-btn'),
            searchInput: document.getElementById('search-input'),
            searchContainer: document.getElementById('search-container'),
            locateBtn: document.getElementById('locate-btn'),
            sidebar: document.getElementById('weather-sidebar'),
            closeSidebar: document.getElementById('close-sidebar'),
            topControls: document.getElementById('top-controls'),
            toggleSidebarBtn: document.getElementById('toggle-sidebar-btn'),
            // Weather elements
            cityName: document.getElementById('city-name'),
            cityCoords: document.getElementById('city-coords'),
            currTemp: document.getElementById('current-temp'),
            currDesc: document.getElementById('current-desc'),
            currIcon: document.getElementById('current-icon'),
            currWind: document.getElementById('current-wind'),
            currRain: document.getElementById('current-rain'),
            windArrow: document.getElementById('wind-arrow'),
            hourlyCont: document.getElementById('hourly-container'),
            dailyCont: document.getElementById('daily-container')
        };

        const wmoCodes = {
            0: { desc: "Despejado", icon: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>` },
            1: { desc: "Parcialmente Nublado", icon: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>` },
            2: { desc: "Nublado", icon: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>` },
            3: { desc: "Cubierto", icon: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>` },
            45: { desc: "Niebla", icon: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>` },
            61: { desc: "Lluvia Leve", icon: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>` },
            63: { desc: "Lluvia", icon: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>` },
            65: { desc: "Lluvia Fuerte", icon: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>` },
            80: { desc: "Chubascos", icon: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>` },
            95: { desc: "Tormenta", icon: `<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>` },
        };

        function getWeatherIcon(code) {
            if (code >= 95) return wmoCodes[95];
            if (code >= 80) return wmoCodes[80];
            if (code >= 61) return wmoCodes[63];
            if (code >= 51) return wmoCodes[61];
            if (code >= 45) return wmoCodes[45];
            if (code === 3) return wmoCodes[3];
            if (code === 2) return wmoCodes[2];
            if (code === 1) return wmoCodes[1];
            return wmoCodes[0];
        }

        async function fetchWeather(lat, lon, cityName = "Tu Ubicación") {
            try {
                els.sidebar.classList.add('open');
                els.topControls.classList.add('mr-80');
                els.toggleSidebarBtn.classList.remove('hidden');
                
                if(cityName === "Tu Ubicación" || !cityName) {
                    const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                    const geoData = await geoRes.json();
                    cityName = geoData.address.city || geoData.address.town || geoData.address.village || "Ubicación Seleccionada";
                }

                els.cityName.textContent = cityName;
                els.cityCoords.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;

                // Fetch expanded data (Wind & Rain)
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m,wind_direction_10m,precipitation&hourly=temperature_2m,weather_code,precipitation_probability,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,wind_speed_10m_max&timezone=auto`;
                const res = await fetch(url);
                const data = await res.json();

                // Current
                const current = data.current;
                const currInfo = getWeatherIcon(current.weather_code);
                els.currTemp.textContent = `${Math.round(current.temperature_2m)}°`;
                els.currDesc.textContent = currInfo.desc;
                els.currIcon.innerHTML = currInfo.icon;
                
                // Current Wind & Rain
                els.currWind.textContent = `${Math.round(current.wind_speed_10m)} km/h`;
                els.windArrow.style.transform = `rotate(${current.wind_direction_10m}deg)`;
                els.currRain.textContent = `${current.precipitation} mm`;

                // Hourly
                els.hourlyCont.innerHTML = '';
                const currentHour = new Date().getHours();
                for(let i = 0; i < 24; i++) {
                    const idx = i + currentHour;
                    if(idx >= data.hourly.time.length) break;
                    
                    const time = data.hourly.time[idx];
                    const temp = Math.round(data.hourly.temperature_2m[idx]);
                    const code = data.hourly.weather_code[idx];
                    const rainProb = data.hourly.precipitation_probability[idx];
                    const windSpeed = Math.round(data.hourly.wind_speed_10m[idx]);
                    const info = getWeatherIcon(code);
                    const hourStr = new Date(time).getHours().toString().padStart(2, '0') + ':00';

                    const el = document.createElement('div');
                    el.className = 'flex flex-col items-center min-w-[70px] p-2 rounded-xl bg-white/5 border border-white/5 snap-start';
                    el.innerHTML = `
                        <span class="text-[10px] text-gray-400 mb-1">${hourStr}</span>
                        <div class="w-6 h-6 text-blue-300 mb-1">${info.icon}</div>
                        <span class="text-sm font-bold mb-1">${temp}°</span>
                        <div class="flex flex-col gap-1 w-full border-t border-white/10 pt-1 mt-1">
                            <div class="flex items-center justify-center text-[10px] text-blue-200">
                                <svg class="w-2.5 h-2.5 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 2zM10 18a2 2 0 100-4 2 2 0 000 4z"/></svg>
                                ${rainProb}%
                            </div>
                            <div class="flex items-center justify-center text-[10px] text-gray-400">
                                <svg class="w-2.5 h-2.5 mr-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"/></svg>
                                ${windSpeed}
                            </div>
                        </div>
                    `;
                    els.hourlyCont.appendChild(el);
                }

                // Daily
                els.dailyCont.innerHTML = '';
                for(let i = 0; i < 7; i++) {
                    const dateStr = data.daily.time[i];
                    const max = Math.round(data.daily.temperature_2m_max[i]);
                    const min = Math.round(data.daily.temperature_2m_min[i]);
                    const rainSum = data.daily.precipitation_sum[i];
                    const maxWind = Math.round(data.daily.wind_speed_10m_max[i]);
                    const code = data.daily.weather_code[i];
                    const info = getWeatherIcon(code);
                    
                    const dayName = new Date(dateStr).toLocaleDateString('es-ES', { weekday: 'short' });

                    const el = document.createElement('div');
                    el.className = 'grid grid-cols-12 gap-2 items-center p-3 rounded-lg bg-white/5 border border-white/5 hover:bg-white/10 transition-colors';
                    el.innerHTML = `
                        <div class="col-span-3 flex items-center gap-2">
                            <span class="text-sm font-bold capitalize text-gray-300 w-8">${i===0?'Hoy':dayName}</span>
                            <div class="w-5 h-5 text-gray-400">${info.icon}</div>
                        </div>
                        
                        <div class="col-span-4 flex items-center gap-2 justify-center">
                            <div class="text-[10px] flex items-center text-blue-300" title="Lluvia Total">
                                <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                                ${rainSum}mm
                            </div>
                            <div class="text-[10px] flex items-center text-gray-400" title="Viento Máx">
                                <svg class="w-3 h-3 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                ${maxWind}
                            </div>
                        </div>

                        <div class="col-span-5 flex items-center gap-2 justify-end text-sm">
                            <span class="text-blue-400 font-medium">${min}°</span>
                            <div class="w-8 h-1 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-blue-500 to-orange-400 w-full opacity-60"></div>
                            </div>
                            <span class="text-orange-400 font-medium">${max}°</span>
                        </div>
                    `;
                    els.dailyCont.appendChild(el);
                }

            } catch (e) {
                console.error(e);
            }
        }

        if("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                map.flyTo([latitude, longitude], 9, { duration: 2 });
                fetchWeather(latitude, longitude);
            });
        }

        els.locateBtn.onclick = () => {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                map.flyTo([latitude, longitude], 10, { duration: 1.5 });
                fetchWeather(latitude, longitude);
            });
        };

        els.closeSidebar.onclick = () => {
            els.sidebar.classList.remove('open');
            els.topControls.classList.remove('mr-80');
        };

        els.toggleSidebarBtn.onclick = () => {
            els.sidebar.classList.add('open');
            els.topControls.classList.add('mr-80');
        };

        els.searchBtn.onclick = () => {
            if(!els.searchContainer.classList.contains('expanded')) {
                els.searchContainer.classList.add('expanded');
                els.searchInput.disabled = false;
                els.searchInput.style.opacity = '1';
                els.searchInput.focus();
            } else {
                performSearch();
            }
        };

        els.searchInput.onkeydown = (e) => { if(e.key === 'Enter') performSearch(); };

        async function performSearch() {
            const query = els.searchInput.value;
            if(!query) {
                els.searchContainer.classList.remove('expanded');
                els.searchInput.style.opacity = '0';
                return;
            }
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if(data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.flyTo([lat, lon], 10, { duration: 2 });
                    fetchWeather(lat, lon, data[0].name || query);
                }
            } catch(e) {}
        }

        async function initRadar() {
            try {
                const res = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                apiData = await res.json();
                let past = apiData.radar.past || [];
                let now = apiData.radar.nowcast || [];
                pastLen = past.length;
                timestamps = [...past, ...now].sort((a,b) => a.time - b.time);
                
                if(timestamps.length) {
                    els.slider.max = timestamps.length - 1;
                    const pct = ((pastLen - 1) / (timestamps.length - 1)) * 100;
                    els.slider.style.background = `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${pct}%, #a855f7 ${pct}%, #a855f7 100%)`;
                    els.marker.style.left = `${pct}%`;
                    els.marker.classList.remove('hidden');
                    setFrame(pastLen - 1);
                }
            } catch(e) {}
        }

        function setFrame(idx) {
            if(idx < 0 || idx >= timestamps.length) return;
            currentIndex = idx;
            els.slider.value = idx;
            const ts = timestamps[idx];
            const d = new Date(ts.time * 1000);
            els.time.innerText = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            els.live.classList.add('hidden');
            if(idx === pastLen - 1) els.live.classList.remove('hidden');

            const key = ts.time;
            
            if(isPlaying && idx < timestamps.length - 1) {
                const nextKey = timestamps[idx+1].time;
                if(!layers[nextKey]) layers[nextKey] = L.tileLayer(`${apiData.host}${timestamps[idx+1].path}/256/{z}/{x}/{y}/2/1_1.png`, { tileSize: 256, opacity: 0, zIndex: 10 }).addTo(map);
            }

            if(!layers[key]) {
                layers[key] = L.tileLayer(`${apiData.host}${ts.path}/256/{z}/{x}/{y}/2/1_1.png`, {
                    tileSize: 256, opacity: 0, zIndex: 10
                }).addTo(map);
            }
            
            layers[key].setOpacity(0.8);
            Object.keys(layers).forEach(k => { if(parseInt(k) !== key) layers[k].setOpacity(0); });
            
            if(Object.keys(layers).length > 25) {
                Object.keys(layers).sort((a,b)=>a-b).forEach(k => {
                    if(Math.abs(k - key) > 3600) { map.removeLayer(layers[k]); delete layers[k]; }
                });
            }
        }

        els.slider.oninput = (e) => { pause(); setFrame(parseInt(e.target.value)); };
        function toggle() { isPlaying ? pause() : play(); }
        function play() {
            isPlaying = true;
            els.playIcon.classList.add('hidden');
            els.pauseIcon.classList.remove('hidden');
            if(currentIndex >= timestamps.length - 1) currentIndex = 0;
            interval = setInterval(() => {
                currentIndex++;
                if(currentIndex >= timestamps.length) currentIndex = 0;
                setFrame(currentIndex);
            }, 200);
        }
        function pause() {
            isPlaying = false;
            els.playIcon.classList.remove('hidden');
            els.pauseIcon.classList.add('hidden');
            clearInterval(interval);
        }

        els.play.onclick = toggle;
        initRadar();
        setInterval(initRadar, 300000);
    </script>
</body>
</html>


