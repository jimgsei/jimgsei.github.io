<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Sombras Solares</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #0d1b2a;
            color: white;
            overflow: hidden;
            touch-action: none;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            transition: transform 0.5s ease-out;
        }
        #map.locked {
            border: 2px solid #ff6b6b;
        }

        #compass {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: rgba(13, 27, 42, 0.9);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .compass-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compass-north {
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff6b6b;
            font-weight: bold;
            font-size: 12px;
        }

        .compass-south {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
        }

        .compass-east {
            position: absolute;
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
        }

        .compass-west {
            position: absolute;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
        }

        .compass-center {
            width: 6px;
            height: 6px;
            background: #ff6b6b;
            border-radius: 50%;
            position: absolute;
        }

        .compass-needle {
            position: absolute;
            width: 2px;
            height: 25px;
            background: #ff6b6b;
            top: 50%;
            left: 50%;
            transform-origin: bottom center;
            transform: translate(-50%, -100%) rotate(0deg);
            transition: transform 0.2s ease-out;
        }

        .controls {
            position: absolute;
            right: 10px;
            top: 110px;
            width: 300px;
            background: rgba(13, 27, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s ease;
        }
        
        .controls.hidden {
            transform: translateX(calc(100% + 20px));
            opacity: 0;
            pointer-events: none;
        }

        #toggleControlsBtn {
            position: absolute;
            top: 19px;
            right: 40px;
            background: rgba(255, 158, 0, 0.8);
            color: #0d1b2a;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }
        
        #hidePanelBtn {
            position: absolute;
            top: 19px;
            right: 15px;
            background: rgba(255, 107, 107, 0.8);
            color: #0d1b2a;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            line-height: 18px;
            padding: 0;
        }

        #showPanelBtn {
            position: absolute;
            top: 110px;
            right: 10px;
            background: rgba(13, 27, 42, 0.95);
            color: #ff9e00;
            border: 1px solid #ff9e00;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            z-index: 950;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .controls.minimized #extra-controls {
            display: none;
        }

        .control-group { margin-bottom: 12px; }
        .control-group:last-child { margin-bottom: 0; }

        label {
            display: block; font-size: 13px; margin-bottom: 6px;
            color: #90e0ef; font-weight: 600;
        }

        input[type="range"] {
            width: 100%; height: 8px; border-radius: 4px; background: rgba(255, 255, 255, 0.1);
            outline: none; -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%;
            background: #ff9e00; cursor: pointer; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s ease;
            border: 2px solid #fff;
        }
        input[type="range"]:active::-webkit-slider-thumb {
            transform: scale(1.2);
        }

        .time-slider-container { display: flex; align-items: center; gap: 8px; }
        .time-slider-container input[type="range"] { flex-grow: 1; }
        #animationBtn {
            background: #ff9e00; color: #0d1b2a; border: none; padding: 6px 10px;
            border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 12px;
            min-width: 70px;
        }

        .info-panel {
            background: rgba(13, 27, 42, 0.9); border-radius: 8px; padding: 12px;
            margin-top: 12px; border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .solar-data { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; }
        .data-item { display: flex; flex-direction: column; }
        .data-label { color: #90e0ef; font-size: 11px; }
        .data-value { font-weight: 600; margin-top: 2px; }

        .shadow-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 500;
        }

        .shadow-caster {
            position: absolute; background: rgba(180, 180, 190, 0.9); border: 1px solid #333;
            z-index: 400; transform: translate(-50%, -50%);
        }

        .shadow {
            position: absolute; background: rgba(0, 0, 0, 0.5);
            transform-origin: 50% 0; z-index: 300;
        }

        #sunPathContainer {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 280px;
            height: 140px;
            transform: translate(-50%, -50%);
            z-index: 200;
            pointer-events: none;
        }
        .sun-path {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .sun-path svg {
            width: 100%; height: 100%; overflow: visible;
        }
        .sun-path-line {
            stroke-width: 1.5;
            fill: none;
            stroke-linecap: round;
        }
        #horizon-circle { 
            stroke: #000; 
            stroke-opacity: 0.8;
            fill: rgba(0,0,0,0.1);
        }
        #sun-path-line { stroke: #ff4444; stroke-width: 2.5; }
        
        .time-marker, .sun-marker {
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .time-marker {
            width: 6px; height: 6px; background: #ffff00;
            z-index: 202; border: 1px solid rgba(0,0,0,0.3);
            box-shadow: 0 0 4px rgba(255, 255, 0, 0.8);
        }

        .time-label {
            position: absolute; font-size: 11px; color: white; background: rgba(0, 0, 0, 0.7);
            padding: 2px 6px; border-radius: 3px; z-index: 203;
            font-weight: bold;
        }
        .sun-marker {
            width: 24px; height: 24px;
            z-index: 201;
            text-align: center;
            line-height: 24px;
            font-size: 16px;
            transition: left 0.1s linear, top 0.1s linear;
        }

        .sun-marker.animated {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .title {
            font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #ff9e00;
            text-align: center; cursor: grab; position: relative; user-select: none;
            padding: 8px 0;
            border-radius: 6px;
            background: rgba(255, 158, 0, 0.1);
        }

        .title:active {
            cursor: grabbing;
        }
        
        .location-search { display: flex; gap: 6px; margin-bottom: 8px; }
        .location-search input {
            flex-grow: 1; border: 1px solid #90e0ef; background: rgba(13, 27, 42, 0.8); color: white;
            padding: 8px; border-radius: 4px; font-size: 13px;
        }
        .location-search button {
            background: #90e0ef; color: #0d1b2a; border: none; padding: 0 12px;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px;
        }

        .location-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
        }

        .location-buttons button {
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
            transition: background-color 0.3s;
        }

        #currentLocationBtn {
            background: #48cae4;
            color: #0d1b2a;
        }
        
        #lockMapBtn {
            background: #4895ef;
            color: #0d1b2a;
        }
        #lockMapBtn.active {
            background: #f77f00;
            color: #0d1b2a;
        }

        #realCompassBtn {
            background: #4895ef;
            color: #0d1b2a;
        }
        #realCompassBtn.active {
            background-color: #f77f00;
            color: #0d1b2a;
        }

        .capital-buttons { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap;}
        .capital-buttons button {
            background: rgba(144, 224, 239, 0.2); color: #ade8f4; border: 1px solid #90e0ef;
            padding: 6px 10px; border-radius: 4px; cursor: pointer; flex-grow: 1;
            font-size: 11px;
        }

        @media (max-width: 768px) {
            .controls {
                width: 90vw;
                right: 5vw;
                top: 110px;
            }
            .location-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="compass">
        <div class="compass-inner">
            <div class="compass-north">N</div>
            <div class="compass-south">S</div>
            <div class="compass-east">E</div>
            <div class="compass-west">O</div>
            <div class="compass-center"></div>
            <div class="compass-needle" id="compassNeedle"></div>
        </div>
    </div>
    <div class="shadow-overlay" id="shadowOverlay">
        <div class="sun-path-overlay" id="sunPathOverlay"></div>
        <div id="sunPathContainer">
            <div class="sun-path" id="sunPath"></div>
        </div>
    </div>

    <div class="controls" id="controlsPanel">
        <div class="title" id="panelTitle">
            <span>Simulador de Sombras</span>
        </div>
        <button id="toggleControlsBtn">Menos Opciones</button>
        <button id="hidePanelBtn">X</button>

        <div id="collapsible-content">
            <div id="essential-controls">
                <div class="control-group">
                    <label for="dateSlider">D√≠a del a√±o: <span id="currentDate"></span></label>
                    <div class="time-slider-container"><span>Ene</span><input type="range" id="dateSlider" min="1" max="365" value="280"><span>Dic</span></div>
                </div>

                <div class="control-group">
                    <label for="timeSlider">Hora del d√≠a: <span id="currentTime">10:30</span></label>
                    <div class="time-slider-container">
                        <button id="animationBtn">‚ñ∂ Animar</button>
                        <input type="range" id="timeSlider" min="5" max="21" step="0.1" value="10.5">
                    </div>
                </div>
            </div>
            <div id="extra-controls">
                <div class="control-group">
                    <label for="objectHeightSlider">Altura Objeto: <span id="objectHeightValue">15</span> m</label>
                    <input type="range" id="objectHeightSlider" min="1" max="50" value="15">
                </div>
                <div class="control-group">
                    <label for="objectWidthSlider">Ancho Objeto: <span id="objectWidthValue">10</span> m</label>
                    <input type="range" id="objectWidthSlider" min="1" max="50" value="10">
                </div>
                <div class="control-group">
                     <label>Ubicaci√≥n</label>
                     <div class="location-search">
                         <input type="text" id="locationSearchInput" placeholder="Buscar ciudad...">
                         <button id="locationSearchBtn">Buscar</button>
                     </div>
                     <div class="location-buttons">
                         <button id="currentLocationBtn" title="Centrar en mi ubicaci√≥n actual">üìç Mi Ubicaci√≥n</button>
                         <button id="lockMapBtn" title="Bloquear/Desbloquear el movimiento del mapa">üîí Bloquear Mapa</button>
                         <button id="realCompassBtn" title="Activar/desactivar br√∫jula y rotaci√≥n del mapa con el m√≥vil">üõ∞Ô∏è Br√∫jula Real</button>
                     </div>
                     <div class="capital-buttons">
                         <button data-lat="40.4168" data-lng="-3.7038">Madrid</button>
                         <button data-lat="41.3851" data-lng="2.1734">Barcelona</button>
                         <button data-lat="37.3891" data-lng="-5.9845">Sevilla</button>
                         <button data-lat="43.2630" data-lng="-2.9350">Bilbao</button>
                     </div>
                </div>
                <div class="info-panel">
                    <div class="solar-data">
                        <div class="data-item"><span class="data-label">Altura solar</span><span class="data-value" id="solarAltitude">-</span></div>
                        <div class="data-item"><span class="data-label">Acimut</span><span class="data-value" id="solarAzimuth">-</span></div>
                        <div class="data-item"><span class="data-label">Longitud sombra</span><span class="data-value" id="shadowLength">-</span></div>
                        <div class="data-item"><span class="data-label">Hora solar</span><span class="data-value" id="solarTime">-</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button id="showPanelBtn">‚öôÔ∏è</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([40.4168, -3.7038], 18);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        }).addTo(map);

        const controlsPanel = document.getElementById('controlsPanel');
        const panelTitle = document.getElementById('panelTitle');
        const dateSlider = document.getElementById('dateSlider');
        const currentDate = document.getElementById('currentDate');
        const timeSlider = document.getElementById('timeSlider');
        const currentTimeDisplay = document.getElementById('currentTime');
        const solarAltitudeDisplay = document.getElementById('solarAltitude');
        const solarAzimuthDisplay = document.getElementById('solarAzimuth');
        const shadowLengthDisplay = document.getElementById('shadowLength');
        const solarTimeDisplay = document.getElementById('solarTime');
        const shadowOverlay = document.getElementById('shadowOverlay');
        const sunPath = document.getElementById('sunPath');
        const objectHeightSlider = document.getElementById('objectHeightSlider');
        const objectWidthSlider = document.getElementById('objectWidthSlider');
        const objectHeightValue = document.getElementById('objectHeightValue');
        const objectWidthValue = document.getElementById('objectWidthValue');
        const toggleControlsBtn = document.getElementById('toggleControlsBtn');
        const hidePanelBtn = document.getElementById('hidePanelBtn');
        const showPanelBtn = document.getElementById('showPanelBtn');
        const locationSearchInput = document.getElementById('locationSearchInput');
        const locationSearchBtn = document.getElementById('locationSearchBtn');
        const currentLocationBtn = document.getElementById('currentLocationBtn');
        const lockMapBtn = document.getElementById('lockMapBtn');
        const realCompassBtn = document.getElementById('realCompassBtn');
        const animationBtn = document.getElementById('animationBtn');
        const compassNeedle = document.getElementById('compassNeedle');
        
        L.DomEvent.disableClickPropagation(controlsPanel);
        L.DomEvent.disableScrollPropagation(controlsPanel);

        let metersPerPixel = 1;
        let animationFrameId = null;
        let isPlaying = false;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let animationStartTime = null;
        const ANIMATION_DURATION = 15000;
        let isMapLocked = false;
        let isRealCompassActive = false;
        
        // --- Paneles y Arrastre ---
        function initPanelDrag() {
            panelTitle.addEventListener('mousedown', startDrag);
            panelTitle.addEventListener('touchstart', startDragTouch);
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', dragTouch);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchend', stopDrag);
        }

        function startDrag(e) {
            if (e.target.closest('button')) return;
            isDragging = true;
            const rect = controlsPanel.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            controlsPanel.style.transition = 'none';
            e.preventDefault();
        }

        function startDragTouch(e) {
            if (e.target.closest('button')) return;
            if (e.touches.length === 1) {
                isDragging = true;
                const rect = controlsPanel.getBoundingClientRect();
                dragOffset.x = e.touches[0].clientX - rect.left;
                dragOffset.y = e.touches[0].clientY - rect.top;
                controlsPanel.style.transition = 'none';
                e.preventDefault();
            }
        }

        function drag(e) {
            if (!isDragging) return;
            const x = e.clientX - dragOffset.x;
            const y = e.clientY - dragOffset.y;
            controlsPanel.style.right = 'auto';
            controlsPanel.style.left = `${x}px`;
            controlsPanel.style.top = `${y}px`;
            e.preventDefault();
        }

        function dragTouch(e) {
            if (!isDragging || e.touches.length !== 1) return;
            const x = e.touches[0].clientX - dragOffset.x;
            const y = e.touches[0].clientY - dragOffset.y;
            controlsPanel.style.right = 'auto';
            controlsPanel.style.left = `${x}px`;
            controlsPanel.style.top = `${y}px`;
            e.preventDefault();
        }

        function stopDrag() {
            isDragging = false;
            controlsPanel.style.transition = 'all 0.3s ease';
        }

        function toggleMinimizePanel() {
             controlsPanel.classList.toggle('minimized');
             toggleControlsBtn.textContent = controlsPanel.classList.contains('minimized') ? 'M√°s Opciones' : 'Menos Opciones';
        }
        
        function hidePanel() {
            controlsPanel.classList.add('hidden');
            showPanelBtn.style.display = 'block';
        }
        
        function showPanel() {
            controlsPanel.classList.remove('hidden');
            showPanelBtn.style.display = 'none';
        }

        // --- C√°lculos y Dibujo ---
        function updateScale() {
            const center = map.getCenter();
            const point1 = map.latLngToContainerPoint(center);
            const point2 = L.point(point1.x + 1, point1.y);
            metersPerPixel = center.distanceTo(map.containerPointToLatLng(point2));
        }

        function createObject() {
            const shadowCaster = document.createElement('div');
            shadowCaster.className = 'shadow-caster';
            shadowCaster.id = 'shadowCaster';
            shadowCaster.style.left = '50%';
            shadowCaster.style.top = '50%';
            shadowOverlay.appendChild(shadowCaster);
        }

        function updateObjectAppearance() {
            const shadowCaster = document.getElementById('shadowCaster');
            if (!shadowCaster) return;
            const heightInMeters = objectHeightSlider.value;
            const widthInMeters = objectWidthSlider.value;
            shadowCaster.style.height = `${heightInMeters / metersPerPixel}px`;
            shadowCaster.style.width = `${widthInMeters / metersPerPixel}px`;
            objectHeightValue.textContent = heightInMeters;
            objectWidthValue.textContent = widthInMeters;
        }

        function dayOfYearToDate(dayOfYear, year = new Date().getFullYear()) {
            return new Date(new Date(year, 0).setDate(dayOfYear));
        }

        function dateToDayOfYear(date) {
            return Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
        }

        function calculateSolarPosition(date, hour, lat, lng) {
            const dayOfYear = dateToDayOfYear(date);
            const latRad = lat * Math.PI / 180;
            const declination = 23.45 * Math.PI / 180 * Math.sin(2 * Math.PI * (284 + dayOfYear) / 365);
            const hourAngleRad = (hour - 12) * 15 * Math.PI / 180;
            const sinAltitude = Math.sin(latRad) * Math.sin(declination) +
                Math.cos(latRad) * Math.cos(declination) * Math.cos(hourAngleRad);
            const altitude = Math.asin(Math.max(-1, Math.min(1, sinAltitude)));
            const cosAzimuth = (Math.sin(declination) - Math.sin(latRad) * Math.sin(altitude)) /
                (Math.cos(latRad) * Math.cos(altitude));
            let azimuth = Math.acos(Math.max(-1, Math.min(1, cosAzimuth))) * 180 / Math.PI;
            if ((hour - 12) > 0) {
                azimuth = 360 - azimuth;
            }
            return {
                altitude: altitude * 180 / Math.PI,
                azimuth: azimuth
            };
        }
        
        const DIAGRAM_W = 280;
        const DIAGRAM_H = 140;
        const DIAGRAM_CX = DIAGRAM_W / 2;
        const DIAGRAM_CY = DIAGRAM_H / 2;
        const DIAGRAM_RADIUS = DIAGRAM_H / 2 - 5;

        function getSunScreenPos(altitude, azimuth) {
            const altRad = altitude * Math.PI / 180;
            const azRad = azimuth * Math.PI / 180;
            const dist = DIAGRAM_RADIUS * Math.cos(altRad);
            const x = DIAGRAM_CX + dist * Math.sin(azRad);
            const y = DIAGRAM_CY - dist * Math.cos(azRad);
            return { x, y };
        }

        function drawSunPath(date, lat, lng) {
            sunPath.innerHTML = '';
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            
            svg.innerHTML = `<circle id="horizon-circle" class="sun-path-line" cx="${DIAGRAM_CX}" cy="${DIAGRAM_CY}" r="${DIAGRAM_RADIUS}"></circle>`;

            const pathPoints = [];
            for (let hour = 4; hour <= 22; hour += 0.25) {
                const solarPos = calculateSolarPosition(date, hour, lat, lng);
                if (solarPos.altitude > 0) {
                    const pos = getSunScreenPos(solarPos.altitude, solarPos.azimuth);
                    pathPoints.push(`${pos.x},${pos.y}`);
                }
            }

            if (pathPoints.length > 1) {
                const pathLine = document.createElementNS(svgNS, "polyline");
                pathLine.id = "sun-path-line";
                pathLine.classList.add("sun-path-line");
                pathLine.setAttribute("points", pathPoints.join(' '));
                svg.appendChild(pathLine);
            }
            sunPath.appendChild(svg);
            
            for (let hour = 6; hour <= 20; hour += 2) {
                const solarPos = calculateSolarPosition(date, hour, lat, lng);
                if (solarPos.altitude > 1) {
                    const pos = getSunScreenPos(solarPos.altitude, solarPos.azimuth);
                    const marker = document.createElement('div');
                    marker.className = 'time-marker';
                    marker.style.left = `${pos.x}px`;
                    marker.style.top = `${pos.y}px`;
                    sunPath.appendChild(marker);
                    
                    const label = document.createElement('div');
                    label.className = 'time-label';
                    label.textContent = `${hour}:00`;
                    label.style.left = `${pos.x}px`;
                    label.style.top = `${pos.y}px`;
                    label.style.transform = `translate(-50%, ${pos.y > DIAGRAM_CY ? '120%' : '-120%'})`;
                    sunPath.appendChild(label);
                }
            }
        }

        function drawCurrentSunPosition(altitude, azimuth) {
            let marker = document.getElementById('currentSun');
            if (!marker) {
                marker = document.createElement('div');
                marker.id = 'currentSun';
                marker.className = 'sun-marker';
                marker.textContent = '‚òÄÔ∏è';
                sunPath.appendChild(marker);
            }

            if (altitude > 0) {
                const pos = getSunScreenPos(altitude, azimuth);
                marker.style.left = `${pos.x}px`;
                marker.style.top = `${pos.y}px`;
                marker.style.display = 'block';
                marker.classList.toggle('animated', isPlaying);
            } else {
                 marker.style.display = 'none';
            }
        }
        
        function updateShadow(date, hour, lat, lng) {
            let shadow = document.getElementById('objectShadow');
             if (!shadow) {
                shadow = document.createElement('div');
                shadow.id = 'objectShadow';
                shadow.className = 'shadow';
                shadowOverlay.appendChild(shadow);
            }

            const solarPos = calculateSolarPosition(date, hour, lat, lng);
            if (solarPos.altitude > 0) {
                const objectHeightMeters = parseFloat(objectHeightSlider.value);
                const objectWidthMeters = parseFloat(objectWidthSlider.value);
                const shadowRatio = 1 / Math.tan(solarPos.altitude * Math.PI / 180);
                const shadowLengthMeters = objectHeightMeters * shadowRatio;
                
                shadow.style.width = `${objectWidthMeters / metersPerPixel}px`;
                shadow.style.height = `${shadowLengthMeters / metersPerPixel}px`;
                shadow.style.left = '50%';
                shadow.style.top = '50%';
                shadow.style.transform = `translateX(-50%) rotate(${solarPos.azimuth}deg)`;
                shadow.style.display = 'block';

                solarAltitudeDisplay.textContent = `${solarPos.altitude.toFixed(1)}¬∞`;
                solarAzimuthDisplay.textContent = `${solarPos.azimuth.toFixed(1)}¬∞`;
                shadowLengthDisplay.textContent = `${shadowLengthMeters.toFixed(1)} m`;
            } else {
                shadow.style.display = 'none';
                solarAltitudeDisplay.textContent = 'Bajo el horizonte';
                solarAzimuthDisplay.textContent = '-';
                shadowLengthDisplay.textContent = '-';
            }
            drawCurrentSunPosition(solarPos.altitude, solarPos.azimuth);
        }

        function updateDisplay(forceSunPathRedraw = false) {
            updateScale();
            updateObjectAppearance();
            const dayOfYear = parseInt(dateSlider.value);
            const date = dayOfYearToDate(dayOfYear);
            const hour = parseFloat(timeSlider.value);
            const hours = Math.floor(hour);
            const minutes = Math.round((hour - hours) * 60);
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            currentTimeDisplay.textContent = timeString;
            solarTimeDisplay.textContent = timeString;
            currentDate.textContent = date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
            const center = map.getCenter();
            
            if (forceSunPathRedraw || sunPath.dataset.day !== dayOfYear.toString() || sunPath.dataset.lat !== center.lat.toString()) {
                 drawSunPath(date, center.lat, center.lng);
                 sunPath.dataset.day = dayOfYear;
                 sunPath.dataset.lat = center.lat;
            }
            updateShadow(date, hour, center.lat, center.lng);
        }

        // --- Animaci√≥n, Br√∫jula, Geolocalizaci√≥n ---
        function stopAnimation() {
            if (isPlaying) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                isPlaying = false;
                animationStartTime = null;
                animationBtn.textContent = '‚ñ∂ Animar';
                const sunMarker = document.getElementById('currentSun');
                if(sunMarker) sunMarker.classList.remove('animated');
            }
        }

        function animateSun(currentTime) {
            if (!isPlaying) return;
            if (!animationStartTime) animationStartTime = currentTime;
            let elapsed = currentTime - animationStartTime;
            if (elapsed >= ANIMATION_DURATION) {
                elapsed = 0;
                animationStartTime = currentTime;
            }
            const progress = elapsed / ANIMATION_DURATION;
            const minHour = parseFloat(timeSlider.min);
            const maxHour = parseFloat(timeSlider.max);
            const hourSpan = maxHour - minHour;
            timeSlider.value = minHour + (progress * hourSpan);
            updateDisplay();
            animationFrameId = requestAnimationFrame(animateSun);
        }

        function toggleAnimation() {
            if (isPlaying) {
                stopAnimation();
            } else {
                isPlaying = true;
                animationBtn.textContent = '‚ùö‚ùö Pausa';
                animationFrameId = requestAnimationFrame(animateSun);
            }
        }
        
        async function searchLocation() {
            const query = locationSearchInput.value;
            if (!query) return;
            stopAnimation();
            const contactEmail = 'simulador.sombras@example.com';
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&email=${contactEmail}`;
            try {
                const response = await fetch(url, { headers: { 'User-Agent': 'SolarShadowSimulator/1.0' } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data && data.length > 0) {
                    map.setView([data[0].lat, data[0].lon], 18);
                    locationSearchInput.value = '';
                } else {
                    alert("Ubicaci√≥n no encontrada.");
                }
            } catch (error) {
                console.error("Search error:", error);
                alert("Error en la b√∫squeda de ubicaci√≥n.");
            }
        }
        
        function getCurrentLocation() {
            navigator.geolocation.getCurrentPosition(
                (position) => map.setView([position.coords.latitude, position.coords.longitude]),
                (error) => alert('No se pudo obtener tu ubicaci√≥n: ' + error.message),
                { enableHighAccuracy: true }
            );
        }

        function toggleMapLock() {
            isMapLocked = !isMapLocked;
            if (isMapLocked) {
                map.dragging.disable();
                map.touchZoom.disable();
                map.doubleClickZoom.disable();
                map.scrollWheelZoom.disable();
                map.boxZoom.disable();
                map.keyboard.disable();
                if (map.tap) map.tap.disable();
                document.getElementById('map').classList.add('locked');
                lockMapBtn.textContent = 'üîì Desbloquear';
                lockMapBtn.classList.add('active');
            } else {
                map.dragging.enable();
                map.touchZoom.enable();
                map.doubleClickZoom.enable();
                map.scrollWheelZoom.enable();
                map.boxZoom.enable();
                map.keyboard.enable();
                if (map.tap) map.tap.enable();
                document.getElementById('map').classList.remove('locked');
                lockMapBtn.textContent = 'üîí Bloquear Mapa';
                lockMapBtn.classList.remove('active');
            }
        }

        function handleOrientation(event) {
            if (typeof event.alpha !== 'number') return;
            const heading = event.alpha;
            map.getContainer().style.transform = `rotate(${-heading}deg)`;
            compassNeedle.style.transform = `translate(-50%, -100%) rotate(${heading}deg)`;
        }

        function toggleRealCompass() {
            if (isRealCompassActive) {
                window.removeEventListener('deviceorientationabsolute', handleOrientation, true);
                isRealCompassActive = false;
                realCompassBtn.classList.remove('active');
                map.getContainer().style.transform = '';
                compassNeedle.style.transform = 'translate(-50%, -100%) rotate(0deg)';
            } else {
                const startCompass = () => {
                    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                    isRealCompassActive = true;
                    realCompassBtn.classList.add('active');
                };

                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                startCompass();
                            } else {
                                alert('Permiso para acceder a la orientaci√≥n denegado.');
                            }
                        }).catch(console.error);
                } else if ('DeviceOrientationEvent' in window) {
                    startCompass();
                } else {
                    alert('Este dispositivo no soporta la br√∫jula en el navegador.');
                }
            }
        }

        // --- Event Listeners ---
        animationBtn.addEventListener('click', toggleAnimation);
        dateSlider.addEventListener('input', () => { stopAnimation(); updateDisplay(); });
        timeSlider.addEventListener('input', () => { stopAnimation(); updateDisplay(); });
        objectHeightSlider.addEventListener('input', () => { stopAnimation(); updateDisplay(); });
        objectWidthSlider.addEventListener('input', () => { stopAnimation(); updateDisplay(); });
        
        map.on('movestart', stopAnimation);
        map.on('moveend', () => updateDisplay(true));
        map.on('zoomend', () => updateDisplay());
        
        currentLocationBtn.addEventListener('click', getCurrentLocation);
        lockMapBtn.addEventListener('click', toggleMapLock);
        realCompassBtn.addEventListener('click', toggleRealCompass);
        
        toggleControlsBtn.addEventListener('click', toggleMinimizePanel);
        hidePanelBtn.addEventListener('click', hidePanel);
        showPanelBtn.addEventListener('click', showPanel);
        
        locationSearchBtn.addEventListener('click', searchLocation);
        locationSearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') searchLocation(); });
        
        document.querySelectorAll('.capital-buttons button').forEach(button => {
            button.addEventListener('click', (e) => {
                stopAnimation();
                map.setView([e.target.dataset.lat, e.target.dataset.lng], 18);
            });
        });

        function initialize() {
            const initialDate = new Date();
            dateSlider.value = dateToDayOfYear(initialDate);
            const currentHour = initialDate.getHours() + initialDate.getMinutes() / 60;
            if (currentHour >= timeSlider.min && currentHour <= timeSlider.max) {
                 timeSlider.value = currentHour;
            }
            createObject();
            initPanelDrag();
            updateDisplay(true);
        }

        initialize();
    </script>
</body>
</html>
